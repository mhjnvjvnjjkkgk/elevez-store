<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Loyalty Rules System - Test Suite</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .test-pass { color: #10b981; }
    .test-fail { color: #ef4444; }
    .test-pending { color: #f59e0b; }
  </style>
</head>
<body class="bg-gray-900 text-white p-8">
  <div class="max-w-6xl mx-auto">
    <h1 class="text-4xl font-bold mb-8">üß™ Loyalty Rules System - Test Suite</h1>

    <!-- Test Controls -->
    <div class="bg-gray-800 rounded-lg p-6 mb-6">
      <h2 class="text-2xl font-bold mb-4">Test Controls</h2>
      <div class="flex gap-4">
        <button onclick="runAllTests()" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-bold">
          Run All Tests
        </button>
        <button onclick="clearResults()" class="px-6 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg font-bold">
          Clear Results
        </button>
        <button onclick="exportResults()" class="px-6 py-3 bg-green-600 hover:bg-green-700 rounded-lg font-bold">
          Export Results
        </button>
      </div>
    </div>

    <!-- Test Results Summary -->
    <div class="grid grid-cols-4 gap-4 mb-6">
      <div class="bg-gray-800 rounded-lg p-4">
        <p class="text-gray-400 text-sm mb-1">Total Tests</p>
        <p id="total-tests" class="text-3xl font-bold">0</p>
      </div>
      <div class="bg-green-900/30 border border-green-500/30 rounded-lg p-4">
        <p class="text-gray-400 text-sm mb-1">Passed</p>
        <p id="passed-tests" class="text-3xl font-bold text-green-500">0</p>
      </div>
      <div class="bg-red-900/30 border border-red-500/30 rounded-lg p-4">
        <p class="text-gray-400 text-sm mb-1">Failed</p>
        <p id="failed-tests" class="text-3xl font-bold text-red-500">0</p>
      </div>
      <div class="bg-yellow-900/30 border border-yellow-500/30 rounded-lg p-4">
        <p class="text-gray-400 text-sm mb-1">Pending</p>
        <p id="pending-tests" class="text-3xl font-bold text-yellow-500">0</p>
      </div>
    </div>

    <!-- Test Categories -->
    <div class="space-y-6">
      <!-- Category 1: Core Service Tests -->
      <div class="bg-gray-800 rounded-lg p-6">
        <h3 class="text-xl font-bold mb-4">üì¶ Core Service Tests</h3>
        <div id="core-tests" class="space-y-2"></div>
      </div>

      <!-- Category 2: Integration Tests -->
      <div class="bg-gray-800 rounded-lg p-6">
        <h3 class="text-xl font-bold mb-4">üîó Integration Tests</h3>
        <div id="integration-tests" class="space-y-2"></div>
      </div>

      <!-- Category 3: Real-Time Sync Tests -->
      <div class="bg-gray-800 rounded-lg p-6">
        <h3 class="text-xl font-bold mb-4">‚ö° Real-Time Sync Tests</h3>
        <div id="sync-tests" class="space-y-2"></div>
      </div>

      <!-- Category 4: Performance Tests -->
      <div class="bg-gray-800 rounded-lg p-6">
        <h3 class="text-xl font-bold mb-4">üöÄ Performance Tests</h3>
        <div id="performance-tests" class="space-y-2"></div>
      </div>

      <!-- Category 5: Edge Case Tests -->
      <div class="bg-gray-800 rounded-lg p-6">
        <h3 class="text-xl font-bold mb-4">üéØ Edge Case Tests</h3>
        <div id="edge-tests" class="space-y-2"></div>
      </div>
    </div>

    <!-- Detailed Test Log -->
    <div class="bg-gray-800 rounded-lg p-6 mt-6">
      <h3 class="text-xl font-bold mb-4">üìã Detailed Test Log</h3>
      <div id="test-log" class="bg-black rounded p-4 font-mono text-sm max-h-96 overflow-y-auto"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
    import { getFirestore, doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

    // Firebase config (use your actual config)
    const firebaseConfig = {
      apiKey: "AIzaSyBCPHq-1_Hn-Ql7Ql7Ql7Ql7Ql7Ql7Ql7Q",
      authDomain: "your-app.firebaseapp.com",
      projectId: "your-project-id",
      storageBucket: "your-app.appspot.com",
      messagingSenderId: "123456789",
      appId: "1:123456789:web:abcdef"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Test results
    let testResults = {
      total: 0,
      passed: 0,
      failed: 0,
      pending: 0,
      tests: []
    };

    // Test runner
    async function runTest(category, name, testFn) {
      const startTime = performance.now();
      testResults.total++;
      updateSummary();

      try {
        await testFn();
        const duration = performance.now() - startTime;
        addTestResult(category, name, 'pass', duration);
        testResults.passed++;
      } catch (error) {
        const duration = performance.now() - startTime;
        addTestResult(category, name, 'fail', duration, error.message);
        testResults.failed++;
      }

      updateSummary();
    }

    function addTestResult(category, name, status, duration, error = null) {
      const result = { category, name, status, duration, error };
      testResults.tests.push(result);

      const categoryEl = document.getElementById(`${category}-tests`);
      const testEl = document.createElement('div');
      testEl.className = `flex items-center justify-between p-3 rounded ${
        status === 'pass' ? 'bg-green-900/20 border border-green-500/30' :
        status === 'fail' ? 'bg-red-900/20 border border-red-500/30' :
        'bg-yellow-900/20 border border-yellow-500/30'
      }`;

      testEl.innerHTML = `
        <div class="flex items-center gap-3">
          <span class="${status === 'pass' ? 'test-pass' : status === 'fail' ? 'test-fail' : 'test-pending'}">
            ${status === 'pass' ? '‚úì' : status === 'fail' ? '‚úó' : '‚è≥'}
          </span>
          <span class="font-medium">${name}</span>
        </div>
        <div class="text-sm text-gray-400">
          ${duration.toFixed(2)}ms
          ${error ? `<br><span class="text-red-400">${error}</span>` : ''}
        </div>
      `;

      categoryEl.appendChild(testEl);

      // Add to log
      const logEl = document.getElementById('test-log');
      const logEntry = document.createElement('div');
      logEntry.className = status === 'pass' ? 'test-pass' : 'test-fail';
      logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${category}/${name}: ${status.toUpperCase()} (${duration.toFixed(2)}ms)${error ? ` - ${error}` : ''}`;
      logEl.appendChild(logEntry);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function updateSummary() {
      document.getElementById('total-tests').textContent = testResults.total;
      document.getElementById('passed-tests').textContent = testResults.passed;
      document.getElementById('failed-tests').textContent = testResults.failed;
      document.getElementById('pending-tests').textContent = testResults.pending;
    }

    // Test Suite
    window.runAllTests = async function() {
      clearResults();
      console.log('üß™ Starting test suite...');

      // Core Service Tests
      await runTest('core', 'Load loyalty rules from Firebase', async () => {
        const rulesRef = doc(db, 'loyaltyRules', 'current');
        const rulesSnap = await getDoc(rulesRef);
        if (!rulesSnap.exists()) throw new Error('Rules document not found');
      });

      await runTest('core', 'Calculate points earned (Bronze tier)', async () => {
        const orderAmount = 100;
        const pointsPerDollar = 0.1;
        const multiplier = 1.0;
        const expected = Math.floor(orderAmount * pointsPerDollar * multiplier);
        const actual = 10; // Simulated
        if (actual !== expected) throw new Error(`Expected ${expected}, got ${actual}`);
      });

      await runTest('core', 'Calculate points earned (Gold tier)', async () => {
        const orderAmount = 100;
        const pointsPerDollar = 0.1;
        const multiplier = 1.5;
        const expected = Math.floor(orderAmount * pointsPerDollar * multiplier);
        const actual = 15; // Simulated
        if (actual !== expected) throw new Error(`Expected ${expected}, got ${actual}`);
      });

      await runTest('core', 'Calculate tier from points (Bronze)', async () => {
        const points = 500;
        const expectedTier = 'bronze';
        const actualTier = 'bronze'; // Simulated
        if (actualTier !== expectedTier) throw new Error(`Expected ${expectedTier}, got ${actualTier}`);
      });

      await runTest('core', 'Calculate tier from points (Gold)', async () => {
        const points = 3000;
        const expectedTier = 'gold';
        const actualTier = 'gold'; // Simulated
        if (actualTier !== expectedTier) throw new Error(`Expected ${expectedTier}, got ${actualTier}`);
      });

      // Integration Tests
      await runTest('integration', 'userPointsService uses dynamic rules', async () => {
        // Check if service imports loyaltyRulesService
        const hasIntegration = true; // Simulated check
        if (!hasIntegration) throw new Error('Service not integrated');
      });

      await runTest('integration', 'CheckoutPage calculates points preview', async () => {
        const hasPreview = true; // Simulated check
        if (!hasPreview) throw new Error('Preview not implemented');
      });

      await runTest('integration', 'RewardsPage subscribes to rule changes', async () => {
        const hasSubscription = true; // Simulated check
        if (!hasSubscription) throw new Error('Subscription not implemented');
      });

      // Real-Time Sync Tests
      await runTest('sync', 'Rules listener fires on change', async () => {
        // Simulate rule change and check if listener fires
        await new Promise(resolve => setTimeout(resolve, 100));
      });

      await runTest('sync', 'Multiple services receive updates', async () => {
        // Check if all services get notified
        await new Promise(resolve => setTimeout(resolve, 100));
      });

      // Performance Tests
      await runTest('performance', 'Load rules (cached) < 1ms', async () => {
        const start = performance.now();
        // Simulated cached load
        const duration = performance.now() - start;
        if (duration > 1) throw new Error(`Too slow: ${duration}ms`);
      });

      await runTest('performance', 'Calculate 1000 points < 10ms', async () => {
        const start = performance.now();
        for (let i = 0; i < 1000; i++) {
          // Simulated calculation
          Math.floor(100 * 0.1 * 1.5);
        }
        const duration = performance.now() - start;
        if (duration > 10) throw new Error(`Too slow: ${duration}ms`);
      });

      // Edge Case Tests
      await runTest('edge', 'Handle 0 points order', async () => {
        const points = Math.floor(0 * 0.1);
        if (points !== 0) throw new Error(`Expected 0, got ${points}`);
      });

      await runTest('edge', 'Handle negative points (should clamp to 0)', async () => {
        const points = Math.max(0, -100);
        if (points !== 0) throw new Error(`Expected 0, got ${points}`);
      });

      await runTest('edge', 'Handle very large order (1 million)', async () => {
        const points = Math.floor(1000000 * 0.1);
        if (points !== 100000) throw new Error(`Expected 100000, got ${points}`);
      });

      console.log('‚úÖ Test suite complete!');
    };

    window.clearResults = function() {
      testResults = { total: 0, passed: 0, failed: 0, pending: 0, tests: [] };
      document.getElementById('core-tests').innerHTML = '';
      document.getElementById('integration-tests').innerHTML = '';
      document.getElementById('sync-tests').innerHTML = '';
      document.getElementById('performance-tests').innerHTML = '';
      document.getElementById('edge-tests').innerHTML = '';
      document.getElementById('test-log').innerHTML = '';
      updateSummary();
    };

    window.exportResults = function() {
      const blob = new Blob([JSON.stringify(testResults, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `loyalty-rules-test-results-${Date.now()}.json`;
      a.click();
    };
  </script>
</body>
</html>
