<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loyalty Rules Creator - ELEVEZ Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0a0a0a;
            color: white;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%);
            border: 1px solid #333;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #00ff88;
            font-size: 2em;
            margin-bottom: 5px;
        }

        .header p {
            color: #888;
            font-size: 0.95em;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #333;
            padding-bottom: 0;
        }

        .tab {
            background: none;
            border: none;
            color: #888;
            padding: 15px 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab:hover {
            color: #00ff88;
        }

        .tab.active {
            color: #00ff88;
            border-bottom-color: #00ff88;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Cards */
        .card {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 1.3em;
            color: #00ff88;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            color: #888;
            margin-bottom: 8px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            background: #0a0a0a;
            border: 1px solid #333;
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #00ff88;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* Buttons */
        .btn {
            background: #00ff88;
            color: black;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1em;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #00dd77;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #333;
            color: white;
        }

        .btn-secondary:hover {
            background: #444;
        }

        .btn-danger {
            background: #ff3b30;
            color: white;
        }

        .btn-danger:hover {
            background: #ff2020;
        }

        /* Tier Cards */
        .tiers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .tier-card {
            background: #1a1a1a;
            border: 2px solid #333;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
        }

        .tier-card:hover {
            border-color: #00ff88;
            transform: translateY(-5px);
        }

        .tier-icon {
            font-size: 3em;
            text-align: center;
            margin-bottom: 10px;
        }

        .tier-name {
            font-size: 1.5em;
            font-weight: bold;
            text-align: center;
            margin-bottom: 5px;
        }

        .tier-points {
            text-align: center;
            color: #888;
            font-size: 0.9em;
            margin-bottom: 15px;
        }

        .tier-benefits {
            list-style: none;
            padding: 0;
        }

        .tier-benefits li {
            padding: 8px 0;
            border-bottom: 1px solid #222;
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
        }

        .tier-benefits li:last-child {
            border-bottom: none;
        }

        /* Preview Section */
        .preview-section {
            background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%);
            border: 2px dashed #333;
            border-radius: 12px;
            padding: 30px;
            margin-top: 30px;
        }

        .preview-title {
            color: #00ff88;
            font-size: 1.5em;
            margin-bottom: 20px;
        }

        /* Calculator */
        .calculator {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 25px;
            margin-top: 20px;
        }

        .calculator-result {
            background: #00ff8820;
            border: 1px solid #00ff88;
            border-radius: 8px;
            padding: 20px;
            margin-top: 15px;
            text-align: center;
        }

        .calculator-result-value {
            font-size: 2.5em;
            color: #00ff88;
            font-weight: bold;
        }

        /* Status Messages */
        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .status-message.success {
            background: #00ff8820;
            border: 1px solid #00ff88;
            color: #00ff88;
        }

        .status-message.error {
            background: #ff3b3020;
            border: 1px solid #ff3b30;
            color: #ff6666;
        }

        .status-message.active {
            display: block;
        }

        /* Loading Spinner */
        .spinner {
            border: 4px solid #333;
            border-top: 4px solid #00ff88;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .redemption-option {
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <h1>üéØ Loyalty Rules Creator</h1>
                <p>Configure your loyalty program rules - Changes apply instantly across the entire system</p>
            </div>
            <button class="btn" onclick="saveAllRules()">üíæ Save All Changes</button>
        </div>

        <!-- Status Message -->
        <div id="statusMessage" class="status-message"></div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('earning', event)">üí∞ Points Earning</button>
            <button class="tab" onclick="switchTab('tiers', event)">üèÜ Tier System</button>
            <button class="tab" onclick="switchTab('redemption', event)">üéÅ Redemption</button>
            <button class="tab" onclick="switchTab('settings', event)">‚öôÔ∏è Settings</button>
            <button class="tab" onclick="switchTab('preview', event)">üëÅÔ∏è Preview</button>
        </div>

        <!-- Tab 1: Points Earning -->
        <div id="earning-tab" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Points Earning Rules</h2>
                </div>

                <div class="form-group">
                    <label class="form-label">Rule Name</label>
                    <input type="text" id="earningName" class="form-input" placeholder="e.g., Standard Earning Rate">
                </div>

                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="earningDescription" class="form-textarea"
                        placeholder="Describe how customers earn points"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Points Per Rupee Spent</label>
                    <input type="number" id="pointsPerDollar" class="form-input" step="0.01" min="0"
                        placeholder="e.g., 0.1 for 1 point per ‚Çπ10" oninput="calculatePoints()">
                    <small style="color: #888; display: block; margin-top: 5px;">
                        Examples: 0.1 = 1 point per ‚Çπ10 | 1 = 1 point per ‚Çπ1 | 10 = 10 points per ‚Çπ1
                    </small>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="earningEnabled" style="width: 20px; height: 20px;">
                        <span class="form-label" style="margin: 0;">Enable Points Earning</span>
                    </label>
                </div>

                <!-- Calculator -->
                <div class="calculator">
                    <h3 style="color: #00ff88; margin-bottom: 15px;">üí° Points Calculator</h3>
                    <div class="form-group">
                        <label class="form-label">Order Amount (‚Çπ)</label>
                        <input type="number" id="calcOrderAmount" class="form-input" placeholder="e.g., 100"
                            oninput="calculatePoints()">
                    </div>
                    <div class="calculator-result" id="calcResult" style="display: none;">
                        <div style="color: #888; font-size: 0.9em; margin-bottom: 10px;">Customer will earn:</div>
                        <div class="calculator-result-value" id="calcPoints">0</div>
                        <div style="color: #888; font-size: 0.9em; margin-top: 5px;">points</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 2: Tier System -->
        <div id="tiers-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Loyalty Tiers</h2>
                    <button class="btn btn-secondary" onclick="addNewTier()">‚ûï Add Tier</button>
                </div>

                <div id="tiersContainer">
                    <!-- Tiers will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Tab 3: Redemption -->
        <div id="redemption-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Redemption Options</h2>
                </div>

                <div id="redemptionContainer">
                    <!-- Redemption options will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Tab 4: Settings -->
        <div id="settings-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Advanced Settings</h2>
                </div>

                <div class="form-group">
                    <label class="form-label">Points Expiration (days)</label>
                    <input type="number" id="pointsExpireDays" class="form-input" min="0"
                        placeholder="0 = never expire">
                    <small style="color: #888; display: block; margin-top: 5px;">
                        Set to 0 for points that never expire
                    </small>
                </div>

                <div class="form-group">
                    <label class="form-label">Rounding Rule</label>
                    <select id="roundingRule" class="form-select">
                        <option value="floor">Floor (round down)</option>
                        <option value="round">Round (nearest)</option>
                        <option value="ceil">Ceil (round up)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="allowPartialRedemption" style="width: 20px; height: 20px;">
                        <span class="form-label" style="margin: 0;">Allow Partial Redemption</span>
                    </label>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="enableBonusEvents" style="width: 20px; height: 20px;">
                        <span class="form-label" style="margin: 0;">Enable Bonus Events</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Tab 5: Preview -->
        <div id="preview-tab" class="tab-content">
            <div class="preview-section">
                <h2 class="preview-title">üìä Current Rules Preview</h2>
                <div id="previewContent">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getFirestore, doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
        import { getAuth } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';

        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCCrE4ikRxLf2fF6ujdhwOcKGfuGRnMBMw",
            authDomain: "elevez-ed97f.firebaseapp.com",
            projectId: "elevez-ed97f",
            storageBucket: "elevez-ed97f.firebasestorage.app",
            messagingSenderId: "440636781018",
            appId: "1:440636781018:web:24d9b6d31d5aee537850e3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentRules = null;

        // Load rules on page load
        window.addEventListener('load', async () => {
            await loadRules();
        });

        async function loadRules() {
            try {
                const rulesRef = doc(db, 'loyaltyRules', 'current');
                const rulesSnap = await getDoc(rulesRef);

                if (rulesSnap.exists()) {
                    currentRules = rulesSnap.data();
                    populateForm();
                    showStatus('Rules loaded successfully', 'success');
                } else {
                    showStatus('No rules found. Using defaults.', 'error');
                }
            } catch (error) {
                console.error('Error loading rules:', error);
                showStatus('Error loading rules: ' + error.message, 'error');
            }
        }

        function populateForm() {
            if (!currentRules) return;

            // Earning rules
            document.getElementById('earningName').value = currentRules.pointsEarning?.name || '';
            document.getElementById('earningDescription').value = currentRules.pointsEarning?.description || '';
            document.getElementById('pointsPerDollar').value = currentRules.pointsEarning?.pointsPerDollar || 0.1;
            document.getElementById('earningEnabled').checked = currentRules.pointsEarning?.enabled || false;

            // Settings
            document.getElementById('pointsExpireDays').value = currentRules.settings?.pointsExpireDays || 365;
            document.getElementById('roundingRule').value = currentRules.settings?.roundingRule || 'floor';
            document.getElementById('allowPartialRedemption').checked = currentRules.settings?.allowPartialRedemption || false;
            document.getElementById('enableBonusEvents').checked = currentRules.settings?.enableBonusEvents || false;

            // Render tiers
            renderTiers();

            // Render redemption options
            renderRedemptionOptions();
        }

        function renderTiers() {
            const container = document.getElementById('tiersContainer');
            if (!currentRules?.tiers) return;

            container.innerHTML = currentRules.tiers.map((tier, index) => `
                <div class="tier-card" style="border-color: ${tier.color}; margin-bottom: 20px;">
                    <div class="tier-icon">${tier.icon}</div>
                    <div class="tier-name" style="color: ${tier.color};">${tier.name}</div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label" style="font-size: 0.85em;">Points Required</label>
                            <input type="number" class="form-input tier-points" data-tier="${index}" 
                                   value="${tier.pointsRequired}" min="0" style="background: #222; border-color: #444;">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label" style="font-size: 0.85em;">Discount %</label>
                            <input type="number" class="form-input tier-discount" data-tier="${index}" 
                                   value="${tier.benefits.discountPercentage}" min="0" max="100" style="background: #222; border-color: #444;">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label" style="font-size: 0.85em;">Points Multiplier</label>
                            <input type="number" class="form-input tier-multiplier" data-tier="${index}" 
                                   value="${tier.benefits.earningMultiplier}" min="1" step="0.1" style="background: #222; border-color: #444;">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label" style="font-size: 0.85em;">Free Shipping Min (‚Çπ)</label>
                            <input type="number" class="form-input tier-shipping" data-tier="${index}" 
                                   value="${tier.benefits.freeShippingThreshold}" min="0" style="background: #222; border-color: #444;">
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 20px; margin-top: 15px; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; color: #888;">
                            <input type="checkbox" class="tier-exclusive" data-tier="${index}" 
                                   ${tier.benefits.exclusiveAccess ? 'checked' : ''} style="width: 18px; height: 18px;">
                            <span>Exclusive Access</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; color: #888;">
                            <input type="checkbox" class="tier-priority" data-tier="${index}" 
                                   ${tier.benefits.prioritySupport ? 'checked' : ''} style="width: 18px; height: 18px;">
                            <span>Priority Support</span>
                        </label>
                    </div>
                </div>
            `).join('');
        }

        function renderRedemptionOptions() {
            const container = document.getElementById('redemptionContainer');
            if (!currentRules?.redemption) return;

            container.innerHTML = currentRules.redemption.map((option, index) => `
                <div class="redemption-option" style="margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label" style="font-size: 0.85em;">Option Name</label>
                            <input type="text" class="form-input redemption-name" data-redemption="${index}" 
                                   value="${option.name}" style="background: #222; border-color: #444;">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label" style="font-size: 0.85em;">Description</label>
                            <input type="text" class="form-input redemption-desc" data-redemption="${index}" 
                                   value="${option.description}" style="background: #222; border-color: #444;">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label" style="font-size: 0.85em;">Points Required</label>
                            <input type="number" class="form-input redemption-points" data-redemption="${index}" 
                                   value="${option.pointsRequired}" min="0" style="background: #222; border-color: #444;">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label" style="font-size: 0.85em;">Rupee Value (‚Çπ)</label>
                            <input type="number" class="form-input redemption-value" data-redemption="${index}" 
                                   value="${option.dollarValue}" min="0" style="background: #222; border-color: #444;">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label" style="font-size: 0.85em;">Min Purchase (‚Çπ)</label>
                            <input type="number" class="form-input redemption-min" data-redemption="${index}" 
                                   value="${option.minimumPurchase}" min="0" style="background: #222; border-color: #444;">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label" style="font-size: 0.85em;">Status</label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin-top: 10px;">
                                <input type="checkbox" class="redemption-enabled" data-redemption="${index}" 
                                       ${option.enabled ? 'checked' : ''} style="width: 20px; height: 20px;">
                                <span style="color: ${option.enabled ? '#00ff88' : '#ff3b30'}; font-weight: bold;">
                                    ${option.enabled ? 'Active' : 'Disabled'}
                                </span>
                            </label>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        window.switchTab = function (tabName, event) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Fallback: find button by onclick attribute
                document.querySelectorAll('.tab').forEach(tab => {
                    if (tab.getAttribute('onclick').includes(`'${tabName}'`)) {
                        tab.classList.add('active');
                    }
                });
            }

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');

            // Load preview if preview tab
            if (tabName === 'preview') {
                loadPreview();
            }
        };

        window.calculatePoints = function () {
            const orderAmount = parseFloat(document.getElementById('calcOrderAmount').value) || 0;
            const pointsPerDollar = parseFloat(document.getElementById('pointsPerDollar').value) || 0.1;

            if (orderAmount > 0) {
                const points = Math.floor(orderAmount * pointsPerDollar);
                document.getElementById('calcPoints').textContent = points;
                document.getElementById('calcResult').style.display = 'block';
            } else {
                document.getElementById('calcResult').style.display = 'none';
            }
        };

        window.saveAllRules = async function () {
            try {
                showStatus('Saving rules...', 'success');

                // Collect tier data from inputs
                const updatedTiers = currentRules.tiers.map((tier, index) => {
                    const pointsEl = document.querySelector(`.tier-points[data-tier="${index}"]`);
                    const discountEl = document.querySelector(`.tier-discount[data-tier="${index}"]`);
                    const multiplierEl = document.querySelector(`.tier-multiplier[data-tier="${index}"]`);
                    const shippingEl = document.querySelector(`.tier-shipping[data-tier="${index}"]`);
                    const exclusiveEl = document.querySelector(`.tier-exclusive[data-tier="${index}"]`);
                    const priorityEl = document.querySelector(`.tier-priority[data-tier="${index}"]`);

                    return {
                        ...tier,
                        pointsRequired: parseInt(pointsEl?.value) || tier.pointsRequired,
                        benefits: {
                            ...tier.benefits,
                            discountPercentage: parseInt(discountEl?.value) || tier.benefits.discountPercentage,
                            earningMultiplier: parseFloat(multiplierEl?.value) || tier.benefits.earningMultiplier,
                            freeShippingThreshold: parseInt(shippingEl?.value) || tier.benefits.freeShippingThreshold,
                            exclusiveAccess: exclusiveEl?.checked ?? tier.benefits.exclusiveAccess,
                            prioritySupport: priorityEl?.checked ?? tier.benefits.prioritySupport
                        }
                    };
                });

                // Collect redemption data from inputs
                const updatedRedemption = currentRules.redemption.map((option, index) => {
                    const nameEl = document.querySelector(`.redemption-name[data-redemption="${index}"]`);
                    const descEl = document.querySelector(`.redemption-desc[data-redemption="${index}"]`);
                    const pointsEl = document.querySelector(`.redemption-points[data-redemption="${index}"]`);
                    const valueEl = document.querySelector(`.redemption-value[data-redemption="${index}"]`);
                    const minEl = document.querySelector(`.redemption-min[data-redemption="${index}"]`);
                    const enabledEl = document.querySelector(`.redemption-enabled[data-redemption="${index}"]`);

                    return {
                        ...option,
                        name: nameEl?.value || option.name,
                        description: descEl?.value || option.description,
                        pointsRequired: parseInt(pointsEl?.value) || option.pointsRequired,
                        dollarValue: parseInt(valueEl?.value) || option.dollarValue,
                        minimumPurchase: parseInt(minEl?.value) || option.minimumPurchase,
                        enabled: enabledEl?.checked ?? option.enabled
                    };
                });

                const updatedRules = {
                    ...currentRules,
                    version: incrementVersion(currentRules?.version || '1.0.0'),
                    lastUpdated: new Date().toISOString(),
                    updatedBy: auth.currentUser?.email || 'admin',
                    tiers: updatedTiers,
                    redemption: updatedRedemption,
                    pointsEarning: {
                        ...currentRules?.pointsEarning,
                        name: document.getElementById('earningName').value,
                        description: document.getElementById('earningDescription').value,
                        pointsPerDollar: parseFloat(document.getElementById('pointsPerDollar').value),
                        enabled: document.getElementById('earningEnabled').checked,
                        updatedAt: new Date().toISOString(),
                    },
                    settings: {
                        pointsExpireDays: parseInt(document.getElementById('pointsExpireDays').value),
                        roundingRule: document.getElementById('roundingRule').value,
                        allowPartialRedemption: document.getElementById('allowPartialRedemption').checked,
                        enableBonusEvents: document.getElementById('enableBonusEvents').checked,
                    }
                };

                const rulesRef = doc(db, 'loyaltyRules', 'current');
                await setDoc(rulesRef, updatedRules);

                currentRules = updatedRules;
                showStatus('‚úÖ Rules saved successfully! Changes will propagate across the system.', 'success');
            } catch (error) {
                console.error('Error saving rules:', error);
                showStatus('‚ùå Error saving rules: ' + error.message, 'error');
            }
        };

        function loadPreview() {
            const previewContent = document.getElementById('previewContent');
            if (!currentRules) {
                previewContent.innerHTML = '<p style="color: #888;">No rules loaded</p>';
                return;
            }

            previewContent.innerHTML = `
                <div style="background: #1a1a1a; border: 1px solid #333; border-radius: 12px; padding: 25px; margin-bottom: 20px;">
                    <h3 style="color: #00ff88; margin-bottom: 15px;">üìä Points Earning</h3>
                    <p style="color: #888; margin-bottom: 10px;">${currentRules.pointsEarning.description}</p>
                    <div style="font-size: 2em; color: #00ff88; font-weight: bold;">${currentRules.pointsEarning.pointsPerDollar} points per ‚Çπ1</div>
                    <div style="color: #888; margin-top: 5px;">Status: ${currentRules.pointsEarning.enabled ? '‚úÖ Enabled' : '‚ùå Disabled'}</div>
                </div>

                <div style="background: #1a1a1a; border: 1px solid #333; border-radius: 12px; padding: 25px; margin-bottom: 20px;">
                    <h3 style="color: #00ff88; margin-bottom: 15px;">üèÜ Tiers (${currentRules.tiers.length})</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        ${currentRules.tiers.map(tier => `
                            <div style="background: #0a0a0a; border: 2px solid ${tier.color}; border-radius: 8px; padding: 15px; text-align: center;">
                                <div style="font-size: 2em;">${tier.icon}</div>
                                <div style="color: ${tier.color}; font-weight: bold; margin: 10px 0;">${tier.name}</div>
                                <div style="color: #888; font-size: 0.9em;">${tier.pointsRequired}+ points</div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div style="background: #1a1a1a; border: 1px solid #333; border-radius: 12px; padding: 25px;">
                    <h3 style="color: #00ff88; margin-bottom: 15px;">üéÅ Redemption Options (${currentRules.redemption.length})</h3>
                    ${currentRules.redemption.map(option => `
                        <div style="background: #0a0a0a; border: 1px solid #333; border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="color: #00ff88; font-weight: bold;">${option.name}</div>
                                    <div style="color: #888; font-size: 0.9em;">${option.description}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="color: #00ff88; font-size: 1.5em; font-weight: bold;">${option.pointsRequired} pts</div>
                                    <div style="color: #888; font-size: 0.9em;">= ‚Çπ${option.dollarValue}</div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function showStatus(message, type) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status-message ${type} active`;
            setTimeout(() => {
                statusEl.classList.remove('active');
            }, 5000);
        }

        function incrementVersion(version) {
            const parts = version.split('.');
            const patch = parseInt(parts[2] || '0') + 1;
            return `${parts[0]}.${parts[1]}.${patch}`;
        }
    </script>
</body>

</html>