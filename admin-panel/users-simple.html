<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Users Management - Simple</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #0a0a0a; color: white; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { color: #00ff88; margin-bottom: 30px; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: #1a1a1a; border: 1px solid #333; border-radius: 10px; padding: 20px; }
        .stat-value { font-size: 2em; font-weight: bold; color: #00ff88; }
        .stat-label { color: #888; margin-top: 5px; }
        .controls { background: #1a1a1a; border: 1px solid #333; border-radius: 10px; padding: 15px; margin-bottom: 20px; display: flex; gap: 10px; }
        button { background: #00ff88; color: black; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: 600; }
        button:hover { background: #00dd77; }
        button.secondary { background: #333; color: white; }
        .users-table { background: #1a1a1a; border: 1px solid #333; border-radius: 10px; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #0a0a0a; padding: 15px; text-align: left; color: #00ff88; font-weight: 600; border-bottom: 1px solid #333; }
        td { padding: 15px; border-bottom: 1px solid #222; }
        tr:hover { background: #222; }
        .tier-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.85em; font-weight: 600; }
        .tier-bronze { background: #cd7f32; color: white; }
        .tier-silver { background: #c0c0c0; color: black; }
        .tier-gold { background: #ffd700; color: black; }
        .tier-platinum { background: #e5e4e2; color: black; }
        .loading { text-align: center; padding: 40px; color: #888; }
        .spinner { border: 4px solid #333; border-top: 4px solid #00ff88; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: #1a1a1a; border: 1px solid #333; border-radius: 10px; padding: 30px; max-width: 500px; width: 90%; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { color: #00ff88; }
        .close-btn { background: none; border: none; color: #888; font-size: 1.5em; cursor: pointer; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; color: #888; margin-bottom: 5px; }
        .form-group input, .form-group textarea { width: 100%; background: #0a0a0a; border: 1px solid #333; color: white; padding: 10px; border-radius: 5px; font-size: 1em; }
        .success-message { background: #00ff8820; border: 1px solid #00ff88; color: #00ff88; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .error-message { background: #ff000020; border: 1px solid #ff0000; color: #ff6666; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üë• Users Management</h1>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalUsers">0</div>
                <div class="stat-label">Total Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalPoints">0</div>
                <div class="stat-label">Total Points</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalOrders">0</div>
                <div class="stat-label">Total Orders</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalRevenue">$0</div>
                <div class="stat-label">Total Revenue</div>
            </div>
        </div>

        <div class="controls">
            <button onclick="loadUsers()">üîÑ Refresh</button>
            <button onclick="window.open('debug-users.html', '_blank')" class="secondary">üîç Debug</button>
        </div>

        <div class="users-table">
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Points</th>
                        <th>Tier</th>
                        <th>Orders</th>
                        <th>Total Spent</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <tr>
                        <td colspan="7" class="loading">
                            <div class="spinner"></div>
                            Loading users...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Add Points Modal -->
    <div class="modal" id="addPointsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Points</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalMessage"></div>
            <div class="form-group">
                <label>User</label>
                <input type="text" id="modalUserId" readonly>
            </div>
            <div class="form-group">
                <label>Current Points</label>
                <input type="text" id="modalCurrentPoints" readonly>
            </div>
            <div class="form-group">
                <label>Points to Add (negative to subtract)</label>
                <input type="number" id="modalPointsToAdd" placeholder="e.g., 100 or -50">
            </div>
            <div class="form-group">
                <label>Reason</label>
                <textarea id="modalReason" placeholder="e.g., Bonus points"></textarea>
            </div>
            <button onclick="submitAddPoints()" style="width: 100%;">‚úÖ Add Points</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { 
            getFirestore, 
            collection, 
            getDocs, 
            doc, 
            getDoc,
            updateDoc,
            addDoc,
            setDoc,
            query,
            where,
            serverTimestamp
        } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCCrE4ikRxLf2fF6ujdhwOcKGfuGRnMBMw",
            authDomain: "elevez-ed97f.firebaseapp.com",
            projectId: "elevez-ed97f",
            storageBucket: "elevez-ed97f.firebasestorage.app",
            messagingSenderId: "440636781018",
            appId: "1:440636781018:web:24d9b6d31d5aee537850e3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let allUsers = [];
        let selectedUser = null;

        window.loadUsers = async function() {
            console.log('üîÑ Loading users...');
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '<tr><td colspan="7" class="loading"><div class="spinner"></div>Loading...</td></tr>';

            try {
                // Step 1: Get all orders to find users
                console.log('üì¶ Loading orders...');
                const ordersSnapshot = await getDocs(collection(db, 'orders'));
                console.log(`Found ${ordersSnapshot.size} orders`);

                const usersMap = new Map();

                // Process each order
                ordersSnapshot.forEach(orderDoc => {
                    const order = orderDoc.data();
                    const userId = order.userId;

                    if (!userId) return;

                    if (!usersMap.has(userId)) {
                        const email = order.shippingAddress?.email || order.email || 'N/A';
                        const firstName = order.shippingAddress?.firstName || '';
                        const lastName = order.shippingAddress?.lastName || '';
                        const fullName = `${firstName} ${lastName}`.trim() || 
                                       order.shippingAddress?.name || 
                                       (email !== 'N/A' ? email.split('@')[0] : 'Unknown User');
                        
                        usersMap.set(userId, {
                            id: userId,
                            name: fullName,
                            email: email,
                            phone: order.shippingAddress?.phone || 'N/A',
                            points: 0,
                            tier: 'bronze',
                            orders: [],
                            totalSpent: 0
                        });
                    }

                    const user = usersMap.get(userId);
                    user.orders.push(order);
                    user.totalSpent += (order.total || 0);
                });

                console.log(`üìä Found ${usersMap.size} unique users from orders`);

                // Step 2: Get user profiles from users collection
                console.log('üë§ Loading user profiles...');
                for (const [userId, user] of usersMap.entries()) {
                    try {
                        const userDoc = await getDoc(doc(db, 'users', userId));
                        if (userDoc.exists()) {
                            const userData = userDoc.data();
                            // Update with stored profile data
                            user.name = `${userData.firstName || ''} ${userData.lastName || ''}`.trim() || user.name;
                            user.email = userData.email || user.email;
                            user.phone = userData.phone || user.phone;
                            user.totalSpent = userData.totalSpent || user.totalSpent;
                        }
                    } catch (err) {
                        console.warn(`Could not load profile for ${userId}:`, err.message);
                    }
                }

                // Step 3: Get points for each user from userPoints collection
                console.log('‚≠ê Loading points from userPoints collection...');
                for (const [userId, user] of usersMap.entries()) {
                    try {
                        const pointsDoc = await getDoc(doc(db, 'userPoints', userId));
                        if (pointsDoc.exists()) {
                            const pointsData = pointsDoc.data();
                            user.points = pointsData.totalPoints || pointsData.points || 0;
                            user.tier = pointsData.tier || 'bronze';
                            console.log(`‚úÖ User ${userId}: ${user.points} points, tier: ${user.tier}`);
                        } else {
                            console.warn(`‚ö†Ô∏è No points document found for user ${userId}`);
                        }
                    } catch (err) {
                        console.warn(`Could not load points for ${userId}:`, err.message);
                    }
                }

                const users = Array.from(usersMap.values());
                console.log(`‚úÖ Loaded ${users.length} users`);

                allUsers = users;
                displayUsers(users);
                updateStats(users);

            } catch (error) {
                console.error('‚ùå Error loading users:', error);
                tbody.innerHTML = `<tr><td colspan="7" class="error-message">Error: ${error.message}</td></tr>`;
            }
        };

        function displayUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #888;">No users found</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => `
                <tr>
                    <td><strong>${user.name}</strong></td>
                    <td>${user.email}</td>
                    <td><strong style="color: #00ff88;">${user.points}</strong></td>
                    <td><span class="tier-badge tier-${user.tier}">${user.tier.toUpperCase()}</span></td>
                    <td>${user.orders.length}</td>
                    <td>$${user.totalSpent.toFixed(2)}</td>
                    <td>
                        <button onclick="openAddPointsModal('${user.id}', '${user.name}', '${user.email}', ${user.points})" style="padding: 8px 15px; font-size: 0.9em;">
                            ‚≠ê Add Points
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function updateStats(users) {
            document.getElementById('totalUsers').textContent = users.length;
            document.getElementById('totalPoints').textContent = users.reduce((sum, u) => sum + u.points, 0).toLocaleString();
            document.getElementById('totalOrders').textContent = users.reduce((sum, u) => sum + u.orders.length, 0);
            document.getElementById('totalRevenue').textContent = '$' + users.reduce((sum, u) => sum + u.totalSpent, 0).toFixed(2);
        }

        window.openAddPointsModal = function(userId, name, email, currentPoints) {
            selectedUser = { id: userId, name, email, currentPoints };
            document.getElementById('modalUserId').value = `${name} (${email})`;
            document.getElementById('modalCurrentPoints').value = currentPoints;
            document.getElementById('modalPointsToAdd').value = '';
            document.getElementById('modalReason').value = '';
            document.getElementById('modalMessage').innerHTML = '';
            document.getElementById('addPointsModal').classList.add('active');
        };

        window.closeModal = function() {
            document.getElementById('addPointsModal').classList.remove('active');
        };

        window.submitAddPoints = async function() {
            const pointsToAdd = parseInt(document.getElementById('modalPointsToAdd').value);
            const reason = document.getElementById('modalReason').value || 'Admin adjustment';
            const messageDiv = document.getElementById('modalMessage');

            if (isNaN(pointsToAdd) || pointsToAdd === 0) {
                messageDiv.innerHTML = '<div class="error-message">Please enter a valid number</div>';
                return;
            }

            try {
                messageDiv.innerHTML = '<div class="loading"><div class="spinner"></div>Adding points...</div>';

                const pointsRef = doc(db, 'userPoints', selectedUser.id);
                const pointsDoc = await getDoc(pointsRef);
                
                const currentPoints = pointsDoc.exists() ? (pointsDoc.data().points || 0) : 0;
                const newPoints = Math.max(0, currentPoints + pointsToAdd);
                const newTier = newPoints >= 3000 ? 'platinum' : newPoints >= 1500 ? 'gold' : newPoints >= 500 ? 'silver' : 'bronze';

                if (pointsDoc.exists()) {
                    await updateDoc(pointsRef, {
                        points: newPoints,
                        tier: newTier,
                        updatedAt: serverTimestamp()
                    });
                } else {
                    await setDoc(pointsRef, {
                        userId: selectedUser.id,
                        points: newPoints,
                        tier: newTier,
                        totalPointsEarned: newPoints,
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    });
                }

                await addDoc(collection(db, 'pointsTransactions'), {
                    userId: selectedUser.id,
                    type: 'admin-adjustment',
                    points: pointsToAdd,
                    reason: reason,
                    timestamp: serverTimestamp()
                });

                messageDiv.innerHTML = `<div class="success-message">‚úÖ Points updated! New balance: ${newPoints}</div>`;
                
                setTimeout(() => {
                    closeModal();
                    loadUsers();
                }, 1500);
            } catch (error) {
                console.error('Error:', error);
                messageDiv.innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
            }
        };

        // Auto-load on page load
        loadUsers();
    </script>
</body>
</html>
