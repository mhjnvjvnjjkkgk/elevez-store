<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Users Management - Simple</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a0a;
            color: white;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: #00ff88;
            margin-bottom: 30px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 10px;
            padding: 20px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #00ff88;
        }

        .stat-label {
            color: #888;
            margin-top: 5px;
        }

        .controls {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }

        button {
            background: #00ff88;
            color: black;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }

        button:hover {
            background: #00dd77;
        }

        button.secondary {
            background: #333;
            color: white;
        }

        .users-table {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 10px;
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #0a0a0a;
            padding: 15px;
            text-align: left;
            color: #00ff88;
            font-weight: 600;
            border-bottom: 1px solid #333;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #222;
        }

        tr:hover {
            background: #222;
        }

        .tier-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .tier-bronze {
            background: #cd7f32;
            color: white;
        }

        .tier-silver {
            background: #c0c0c0;
            color: black;
        }

        .tier-gold {
            background: #ffd700;
            color: black;
        }

        .tier-platinum {
            background: #e5e4e2;
            color: black;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        .spinner {
            border: 4px solid #333;
            border-top: 4px solid #00ff88;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 10px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #00ff88;
        }

        .close-btn {
            background: none;
            border: none;
            color: #888;
            font-size: 1.5em;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #888;
            margin-bottom: 5px;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            background: #0a0a0a;
            border: 1px solid #333;
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 1em;
        }

        .success-message {
            background: #00ff8820;
            border: 1px solid #00ff88;
            color: #00ff88;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .error-message {
            background: #ff000020;
            border: 1px solid #ff0000;
            color: #ff6666;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üë• Users Management</h1>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalUsers">0</div>
                <div class="stat-label">Total Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalPoints">0</div>
                <div class="stat-label">Total Points</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalOrders">0</div>
                <div class="stat-label">Total Orders</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalRevenue">$0</div>
                <div class="stat-label">Total Revenue</div>
            </div>
        </div>

        <div class="controls">
            <button onclick="loadUsers()">üîÑ Refresh</button>
            <button onclick="fixAllUserPoints()" style="background: #ff6666;">üîß Fix Points Now</button>
            <button onclick="window.open('debug-users.html', '_blank')" class="secondary">üîç Debug</button>
        </div>

        <div class="users-table">
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Points</th>
                        <th>Tier</th>
                        <th>Orders</th>
                        <th>Total Spent</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <tr>
                        <td colspan="7" class="loading">
                            <div class="spinner"></div>
                            Loading users...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Add Points Modal -->
    <div class="modal" id="addPointsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Points</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalMessage"></div>
            <div class="form-group">
                <label>User</label>
                <input type="text" id="modalUserId" readonly>
            </div>
            <div class="form-group">
                <label>Current Points</label>
                <input type="text" id="modalCurrentPoints" readonly>
            </div>
            <div class="form-group">
                <label>Points to Add (negative to subtract)</label>
                <input type="number" id="modalPointsToAdd" placeholder="e.g., 100 or -50">
            </div>
            <div class="form-group">
                <label>Reason</label>
                <textarea id="modalReason" placeholder="e.g., Bonus points"></textarea>
            </div>
            <button onclick="submitAddPoints()" style="width: 100%;">‚úÖ Add Points</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import {
            getFirestore,
            collection,
            getDocs,
            doc,
            getDoc,
            updateDoc,
            addDoc,
            setDoc,
            query,
            where,
            serverTimestamp
        } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCCrE4ikRxLf2fF6ujdhwOcKGfuGRnMBMw",
            authDomain: "elevez-ed97f.firebaseapp.com",
            projectId: "elevez-ed97f",
            storageBucket: "elevez-ed97f.firebasestorage.app",
            messagingSenderId: "440636781018",
            appId: "1:440636781018:web:24d9b6d31d5aee537850e3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let allUsers = [];
        let selectedUser = null;

        window.loadUsers = async function () {
            console.log('üîÑ Loading users...');
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '<tr><td colspan="7" class="loading"><div class="spinner"></div>Loading...</td></tr>';

            try {
                // Step 1: Get all orders to find users
                console.log('üì¶ Loading orders...');
                const ordersSnapshot = await getDocs(collection(db, 'orders'));
                console.log(`Found ${ordersSnapshot.size} orders`);

                const usersMap = new Map();

                // Process each order
                ordersSnapshot.forEach(orderDoc => {
                    const order = orderDoc.data();
                    const userId = order.userId;

                    if (!userId) return;

                    if (!usersMap.has(userId)) {
                        const email = order.shippingAddress?.email || order.email || 'N/A';
                        const firstName = order.shippingAddress?.firstName || '';
                        const lastName = order.shippingAddress?.lastName || '';
                        const fullName = `${firstName} ${lastName}`.trim() ||
                            order.shippingAddress?.name ||
                            (email !== 'N/A' ? email.split('@')[0] : 'Unknown User');

                        usersMap.set(userId, {
                            id: userId,
                            name: fullName,
                            email: email,
                            phone: order.shippingAddress?.phone || 'N/A',
                            points: 0,
                            tier: 'bronze',
                            orders: [],
                            totalSpent: 0
                        });
                    }

                    const user = usersMap.get(userId);
                    user.orders.push(order);
                    // Check multiple possible field names for order total
                    const orderTotal = order.total || order.totalAmount || order.orderTotal || order.grandTotal || order.amount || order.subtotal || 0;
                    user.totalSpent += orderTotal;
                    console.log(`  üì¶ Order for ${userId}: total=${order.total}, totalAmount=${order.totalAmount}, subtotal=${order.subtotal}, using: ‚Çπ${orderTotal}`);
                });

                console.log(`üìä Found ${usersMap.size} unique users from orders`);

                // Step 2: Get user profiles from users collection
                console.log('üë§ Loading user profiles...');
                for (const [userId, user] of usersMap.entries()) {
                    try {
                        const userDoc = await getDoc(doc(db, 'users', userId));
                        if (userDoc.exists()) {
                            const userData = userDoc.data();
                            // Update with stored profile data
                            user.name = `${userData.firstName || ''} ${userData.lastName || ''}`.trim() || user.name;
                            user.email = userData.email || user.email;
                            user.phone = userData.phone || user.phone;
                            // Keep the calculated totalSpent from orders (more reliable)
                            // Only override if user data has a higher value
                            if ((userData.totalSpent || 0) > user.totalSpent) {
                                user.totalSpent = userData.totalSpent;
                            }
                        }
                    } catch (err) {
                        console.warn(`Could not load profile for ${userId}:`, err.message);
                    }
                }

                // Step 3: Get points from BOTH userPoints AND loyaltyProfiles, then MERGE
                console.log('‚≠ê Loading points from BOTH userPoints and loyaltyProfiles collections...');
                for (const [userId, user] of usersMap.entries()) {
                    try {
                        let userPointsValue = 0;
                        let loyaltyPointsValue = 0;
                        let tier = 'bronze';

                        // Check userPoints collection
                        const pointsDoc = await getDoc(doc(db, 'userPoints', userId));
                        if (pointsDoc.exists()) {
                            const pointsData = pointsDoc.data();
                            userPointsValue = pointsData.totalPoints || pointsData.points || 0;
                            tier = pointsData.tier || tier;
                            console.log(`  üìä userPoints: ${userPointsValue} points`);
                        }

                        // ALSO check loyaltyProfiles collection (always, not just as fallback)
                        const loyaltyDoc = await getDoc(doc(db, 'loyaltyProfiles', userId));
                        if (loyaltyDoc.exists()) {
                            const loyaltyData = loyaltyDoc.data();
                            loyaltyPointsValue = loyaltyData.points || loyaltyData.totalPointsEarned || 0;
                            // Use loyaltyProfiles tier if it exists and userPoints tier is default
                            if (loyaltyData.tier && tier === 'bronze') {
                                tier = (loyaltyData.tier || 'Bronze').toLowerCase();
                            }
                            console.log(`  üìä loyaltyProfiles: ${loyaltyPointsValue} points`);
                        }

                        // MERGE: Take the MAXIMUM points from either collection
                        user.points = Math.max(userPointsValue, loyaltyPointsValue);
                        user.tier = tier;

                        console.log(`‚úÖ User ${userId}: ${user.points} points (merged), tier: ${user.tier}`);

                        if (user.points === 0 && !pointsDoc.exists() && !loyaltyDoc.exists()) {
                            console.warn(`‚ö†Ô∏è No points document found for user ${userId} in either collection`);
                        }
                    } catch (err) {
                        console.warn(`Could not load points for ${userId}:`, err.message);
                    }
                }

                const users = Array.from(usersMap.values());
                console.log(`‚úÖ Loaded ${users.length} users`);

                allUsers = users;
                displayUsers(users);
                updateStats(users);

            } catch (error) {
                console.error('‚ùå Error loading users:', error);
                tbody.innerHTML = `<tr><td colspan="7" class="error-message">Error: ${error.message}</td></tr>`;
            }
        };

        function displayUsers(users) {
            const tbody = document.getElementById('usersTableBody');

            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #888;">No users found</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => `
                <tr>
                    <td><strong>${user.name}</strong></td>
                    <td>${user.email}</td>
                    <td><strong style="color: #00ff88;">${user.points}</strong></td>
                    <td><span class="tier-badge tier-${user.tier}">${user.tier.toUpperCase()}</span></td>
                    <td>${user.orders.length}</td>
                    <td>$${user.totalSpent.toFixed(2)}</td>
                    <td>
                        <button onclick="openAddPointsModal('${user.id}', '${user.name}', '${user.email}', ${user.points})" style="padding: 8px 15px; font-size: 0.9em;">
                            ‚≠ê Add Points
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function updateStats(users) {
            document.getElementById('totalUsers').textContent = users.length;
            document.getElementById('totalPoints').textContent = users.reduce((sum, u) => sum + u.points, 0).toLocaleString();
            document.getElementById('totalOrders').textContent = users.reduce((sum, u) => sum + u.orders.length, 0);
            document.getElementById('totalRevenue').textContent = '$' + users.reduce((sum, u) => sum + u.totalSpent, 0).toFixed(2);
        }

        window.openAddPointsModal = function (userId, name, email, currentPoints) {
            selectedUser = { id: userId, name, email, currentPoints };
            document.getElementById('modalUserId').value = `${name} (${email})`;
            document.getElementById('modalCurrentPoints').value = currentPoints;
            document.getElementById('modalPointsToAdd').value = '';
            document.getElementById('modalReason').value = '';
            document.getElementById('modalMessage').innerHTML = '';
            document.getElementById('addPointsModal').classList.add('active');
        };

        window.closeModal = function () {
            document.getElementById('addPointsModal').classList.remove('active');
        };

        window.submitAddPoints = async function () {
            const pointsToAdd = parseInt(document.getElementById('modalPointsToAdd').value);
            const reason = document.getElementById('modalReason').value || 'Admin adjustment';
            const messageDiv = document.getElementById('modalMessage');

            if (isNaN(pointsToAdd) || pointsToAdd === 0) {
                messageDiv.innerHTML = '<div class="error-message">Please enter a valid number</div>';
                return;
            }

            try {
                messageDiv.innerHTML = '<div class="loading"><div class="spinner"></div>Adding points to both collections...</div>';

                // Get current points from BOTH collections
                let userPointsValue = 0;
                let loyaltyPointsValue = 0;

                // Check userPoints collection
                const userPointsRef = doc(db, 'userPoints', selectedUser.id);
                const userPointsDoc = await getDoc(userPointsRef);
                if (userPointsDoc.exists()) {
                    const data = userPointsDoc.data();
                    userPointsValue = data.totalPoints || data.points || 0;
                }

                // Check loyaltyProfiles collection
                const loyaltyRef = doc(db, 'loyaltyProfiles', selectedUser.id);
                const loyaltyDoc = await getDoc(loyaltyRef);
                if (loyaltyDoc.exists()) {
                    const data = loyaltyDoc.data();
                    loyaltyPointsValue = data.points || data.totalPointsEarned || 0;
                }

                // Calculate new points starting from the current MAX between both collections
                const currentMaxPoints = Math.max(userPointsValue, loyaltyPointsValue);
                const newPoints = Math.max(0, currentMaxPoints + pointsToAdd);
                const newTier = newPoints >= 3000 ? 'platinum' : newPoints >= 1500 ? 'gold' : newPoints >= 500 ? 'silver' : 'bronze';

                console.log(`üìä Current: userPoints=${userPointsValue}, loyaltyProfiles=${loyaltyPointsValue}, max=${currentMaxPoints}`);
                console.log(`üìä Adding ${pointsToAdd} points ‚Üí New total: ${newPoints}`);

                // Update userPoints collection (for userPointsService)
                if (userPointsDoc.exists()) {
                    await updateDoc(userPointsRef, {
                        totalPoints: newPoints,
                        tier: newTier,
                        updatedAt: serverTimestamp()
                    });
                } else {
                    await setDoc(userPointsRef, {
                        userId: selectedUser.id,
                        totalPoints: newPoints,
                        tier: newTier,
                        pointsHistory: [],
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    });
                }

                // ALSO update loyaltyProfiles collection (for website loyaltyService)
                if (loyaltyDoc.exists()) {
                    await updateDoc(loyaltyRef, {
                        points: newPoints,
                        totalPointsEarned: newPoints,
                        tier: newTier.charAt(0).toUpperCase() + newTier.slice(1), // Capitalize for loyaltyProfiles
                        lastUpdated: serverTimestamp()
                    });
                } else {
                    await setDoc(loyaltyRef, {
                        userId: selectedUser.id,
                        points: newPoints,
                        totalPointsEarned: newPoints,
                        tier: newTier.charAt(0).toUpperCase() + newTier.slice(1),
                        socialShares: { instagram: false, whatsapp: false, facebook: false },
                        orderCount: 0,
                        joinedAt: serverTimestamp(),
                        lastUpdated: serverTimestamp()
                    });
                }

                // Log transaction
                await addDoc(collection(db, 'pointsTransactions'), {
                    userId: selectedUser.id,
                    type: 'admin-adjustment',
                    points: pointsToAdd,
                    reason: reason,
                    timestamp: serverTimestamp()
                });

                console.log(`‚úÖ Updated both collections to ${newPoints} points`);
                messageDiv.innerHTML = `<div class="success-message">‚úÖ Points updated in both collections! New balance: ${newPoints}</div>`;

                setTimeout(() => {
                    closeModal();
                    loadUsers();
                }, 1500);
            } catch (error) {
                console.error('Error:', error);
                messageDiv.innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
            }
        };

        window.fixAllUserPoints = async function () {
            // Proceed directly without confirmation for easier testing
            console.log('üîß Starting points fix...');
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '<tr><td colspan="7" class="loading"><div class="spinner"></div>Fixing points...</td></tr>';

            try {
                // Step 1: Get all orders
                console.log('üì¶ Loading orders...');
                const ordersSnapshot = await getDocs(collection(db, 'orders'));
                console.log(`Found ${ordersSnapshot.size} orders`);

                // Step 2: Calculate points per user
                const userPointsMap = new Map();

                ordersSnapshot.forEach(orderDoc => {
                    const order = orderDoc.data();
                    const userId = order.userId;

                    if (!userId) return;

                    if (!userPointsMap.has(userId)) {
                        const email = order.shippingAddress?.email || order.email || 'N/A';
                        const firstName = order.shippingAddress?.firstName || '';
                        const lastName = order.shippingAddress?.lastName || '';
                        const fullName = `${firstName} ${lastName}`.trim() ||
                            order.shippingAddress?.name ||
                            (email !== 'N/A' ? email.split('@')[0] : 'Unknown User');

                        userPointsMap.set(userId, {
                            userId,
                            email,
                            displayName: fullName,
                            totalPoints: 0,
                            orderCount: 0,
                            totalSpent: 0
                        });
                    }

                    const userData = userPointsMap.get(userId);
                    userData.orderCount++;
                    // Use correct field name (totalAmount, not total)
                    const orderTotal = order.totalAmount || order.total || order.subtotal || 0;
                    userData.totalSpent += orderTotal;
                    // Calculate points: 1 point per ‚Çπ10 spent (dynamic rule)
                    const pointsFromOrder = Math.floor(orderTotal / 10);
                    userData.totalPoints += pointsFromOrder;
                    console.log(`  üì¶ Order: ‚Çπ${orderTotal} ‚Üí ${pointsFromOrder} points`);
                });

                console.log(`üìä Found ${userPointsMap.size} users with orders`);

                // Step 3: Write to BOTH userPoints and loyaltyProfiles collections
                // RECALCULATE FROM SCRATCH: Signup bonus (100) + points from orders
                const SIGNUP_BONUS = 100; // Standard signup bonus for all users
                let fixed = 0;
                for (const [userId, userData] of userPointsMap.entries()) {
                    try {
                        const loyaltyDocRef = doc(db, 'loyaltyProfiles', userId);
                        const existingLoyaltyDoc = await getDoc(loyaltyDocRef);

                        // Check if user has a loyalty profile (means they signed up)
                        const hasSignupBonus = existingLoyaltyDoc.exists();

                        // Total points = signup bonus (if signed up) + points from orders
                        const finalPoints = (hasSignupBonus ? SIGNUP_BONUS : 0) + userData.totalPoints;
                        console.log(`  üí∞ User ${userId}: Signup=${hasSignupBonus ? 100 : 0} + Orders=${userData.totalPoints} = ${finalPoints} total`);

                        const tier = finalPoints >= 3000 ? 'platinum' :
                            finalPoints >= 1500 ? 'gold' :
                                finalPoints >= 500 ? 'silver' : 'bronze';

                        // Write to userPoints collection
                        const pointsData = {
                            userId,
                            email: userData.email,
                            displayName: userData.displayName,
                            totalPoints: finalPoints,
                            points: finalPoints,
                            tier,
                            orderCount: userData.orderCount,
                            pointsHistory: [],
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString(),
                            lastPurchaseDate: new Date().toISOString()
                        };

                        const pointsRef = doc(db, 'userPoints', userId);
                        await setDoc(pointsRef, pointsData);  // Full overwrite, no merge

                        // ALSO write to loyaltyProfiles collection - Full overwrite
                        const loyaltyData = {
                            userId,
                            points: finalPoints,
                            totalPointsEarned: finalPoints,
                            tier: tier.charAt(0).toUpperCase() + tier.slice(1),
                            orderCount: userData.orderCount,
                            socialShares: { instagram: false, whatsapp: false, facebook: false },
                            joinedAt: serverTimestamp(),
                            lastUpdated: serverTimestamp()
                        };
                        await setDoc(loyaltyDocRef, loyaltyData);  // Full overwrite, no merge

                        console.log(`‚úÖ Fixed ${userData.displayName}: ${finalPoints} points (${tier}) in BOTH collections`);
                        fixed++;
                    } catch (err) {
                        console.error(`‚ùå Failed to fix ${userId}:`, err);
                    }
                }

                console.log(`üéâ Fixed ${fixed} users!`);
                alert(`‚úÖ Successfully fixed points for ${fixed} users!\n\nPoints have been RESET to:\n- 100 signup bonus + points from orders\n\nClick OK to refresh.`);

                // Wait 2 seconds for Firebase writes to commit, then reload
                console.log('‚è≥ Waiting for Firebase to commit writes...');
                setTimeout(() => {
                    console.log('üîÑ Reloading users...');
                    loadUsers();
                }, 2000);

            } catch (error) {
                console.error('‚ùå Error fixing points:', error);
                alert(`Error: ${error.message}\n\nCheck console for details.`);
                tbody.innerHTML = `<tr><td colspan="7" class="error-message">Error: ${error.message}</td></tr>`;
            }
        };

        // Auto-load on page load
        loadUsers();
    </script>
</body>

</html>