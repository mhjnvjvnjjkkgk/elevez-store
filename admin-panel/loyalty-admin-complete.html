<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loyalty System - Complete Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #0a0a0a; }
        .tab-active { background: #00ff88 !important; color: black !important; }
        .glow { box-shadow: 0 0 20px rgba(0, 255, 136, 0.3); }
    </style>
</head>
<body class="text-white">
    <div class="max-w-7xl mx-auto p-6">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-4xl font-bold text-[#00ff88] mb-2">üéØ Loyalty System Admin</h1>
            <p class="text-gray-400">Manage rules, users, and points in real-time</p>
        </div>

        <!-- Tabs -->
        <div class="flex gap-2 mb-6 overflow-x-auto">
            <button onclick="switchTab('rules')" id="tab-rules" class="tab-active px-6 py-3 rounded-lg font-bold whitespace-nowrap">
                ‚öôÔ∏è Loyalty Rules
            </button>
            <button onclick="switchTab('users')" id="tab-users" class="bg-gray-800 hover:bg-gray-700 px-6 py-3 rounded-lg font-bold whitespace-nowrap">
                üë• User Points
            </button>
            <button onclick="switchTab('analytics')" id="tab-analytics" class="bg-gray-800 hover:bg-gray-700 px-6 py-3 rounded-lg font-bold whitespace-nowrap">
                üìä Analytics
            </button>
        </div>

        <!-- Tab Content -->
        <div id="content-rules" class="tab-content">
            <iframe src="loyalty-rules.html" class="w-full h-[800px] rounded-lg border border-gray-700"></iframe>
        </div>

        <div id="content-users" class="tab-content hidden">
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-gray-900 border border-gray-700 rounded-lg p-6">
                    <div class="text-3xl font-bold text-[#00ff88]" id="stat-total-users">0</div>
                    <div class="text-gray-400 text-sm mt-1">Total Users</div>
                </div>
                <div class="bg-gray-900 border border-gray-700 rounded-lg p-6">
                    <div class="text-3xl font-bold text-[#00ff88]" id="stat-total-points">0</div>
                    <div class="text-gray-400 text-sm mt-1">Total Points</div>
                </div>
                <div class="bg-gray-900 border border-gray-700 rounded-lg p-6">
                    <div class="text-3xl font-bold text-[#00ff88]" id="stat-total-orders">0</div>
                    <div class="text-gray-400 text-sm mt-1">Total Orders</div>
                </div>
                <div class="bg-gray-900 border border-gray-700 rounded-lg p-6">
                    <div class="text-3xl font-bold text-[#00ff88]" id="stat-avg-points">0</div>
                    <div class="text-gray-400 text-sm mt-1">Avg Points/User</div>
                </div>
            </div>

            <!-- Controls -->
            <div class="bg-gray-900 border border-gray-700 rounded-lg p-4 mb-6 flex gap-3">
                <button onclick="loadUsers()" class="bg-[#00ff88] hover:bg-[#00dd77] text-black px-6 py-2 rounded-lg font-bold">
                    üîÑ Refresh
                </button>
                <button onclick="syncAllPoints()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-bold">
                    üîÑ Sync All Points
                </button>
                <input type="text" id="search-users" placeholder="Search users..." 
                       class="flex-1 bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white"
                       oninput="filterUsers()">
            </div>

            <!-- Users Table -->
            <div class="bg-gray-900 border border-gray-700 rounded-lg overflow-hidden">
                <table class="w-full">
                    <thead class="bg-black">
                        <tr>
                            <th class="px-6 py-4 text-left text-[#00ff88] font-bold">Name</th>
                            <th class="px-6 py-4 text-left text-[#00ff88] font-bold">Email</th>
                            <th class="px-6 py-4 text-left text-[#00ff88] font-bold">Points</th>
                            <th class="px-6 py-4 text-left text-[#00ff88] font-bold">Tier</th>
                            <th class="px-6 py-4 text-left text-[#00ff88] font-bold">Orders</th>
                            <th class="px-6 py-4 text-left text-[#00ff88] font-bold">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body">
                        <tr>
                            <td colspan="6" class="px-6 py-12 text-center text-gray-400">
                                <div class="animate-spin w-8 h-8 border-4 border-[#00ff88] border-t-transparent rounded-full mx-auto mb-4"></div>
                                Loading users...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="content-analytics" class="tab-content hidden">
            <div class="bg-gray-900 border border-gray-700 rounded-lg p-8 text-center">
                <h2 class="text-2xl font-bold mb-4">üìä Analytics Dashboard</h2>
                <p class="text-gray-400">Coming soon...</p>
            </div>
        </div>
    </div>

    <!-- Add Points Modal -->
    <div id="add-points-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
        <div class="bg-gray-900 border border-gray-700 rounded-lg p-8 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-[#00ff88]">Add/Remove Points</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            
            <div id="modal-message" class="mb-4"></div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-gray-400 text-sm mb-2">User</label>
                    <input type="text" id="modal-user-name" readonly 
                           class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white">
                </div>
                
                <div>
                    <label class="block text-gray-400 text-sm mb-2">Current Points</label>
                    <input type="text" id="modal-current-points" readonly 
                           class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white">
                </div>
                
                <div>
                    <label class="block text-gray-400 text-sm mb-2">Points to Add (negative to subtract)</label>
                    <input type="number" id="modal-points-amount" placeholder="e.g., 100 or -50"
                           class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white">
                </div>
                
                <div>
                    <label class="block text-gray-400 text-sm mb-2">Reason</label>
                    <textarea id="modal-reason" placeholder="e.g., Bonus points" rows="3"
                              class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white"></textarea>
                </div>
                
                <button onclick="submitAddPoints()" 
                        class="w-full bg-[#00ff88] hover:bg-[#00dd77] text-black px-6 py-3 rounded-lg font-bold">
                    ‚úÖ Update Points
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { 
            getFirestore, 
            collection, 
            getDocs, 
            doc, 
            getDoc,
            setDoc,
            updateDoc,
            serverTimestamp,
            onSnapshot
        } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCCrE4ikRxLf2fF6ujdhwOcKGfuGRnMBMw",
            authDomain: "elevez-ed97f.firebaseapp.com",
            projectId: "elevez-ed97f",
            storageBucket: "elevez-ed97f.firebasestorage.app",
            messagingSenderId: "440636781018",
            appId: "1:440636781018:web:24d9b6d31d5aee537850e3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let allUsers = [];
        let selectedUser = null;
        let loyaltyRules = null;

        // Load loyalty rules
        async function loadLoyaltyRules() {
            try {
                const rulesDoc = await getDoc(doc(db, 'loyaltyRules', 'current'));
                if (rulesDoc.exists()) {
                    loyaltyRules = rulesDoc.data();
                    console.log('‚úÖ Loaded loyalty rules:', loyaltyRules);
                } else {
                    console.warn('‚ö†Ô∏è No loyalty rules found, using defaults');
                    loyaltyRules = {
                        pointsEarning: { pointsPerDollar: 0.1 },
                        tiers: [
                            { id: 'bronze', pointsRequired: 0 },
                            { id: 'silver', pointsRequired: 1000 },
                            { id: 'gold', pointsRequired: 2500 },
                            { id: 'platinum', pointsRequired: 5000 }
                        ]
                    };
                }
            } catch (error) {
                console.error('‚ùå Error loading loyalty rules:', error);
            }
        }

        // Calculate tier from points
        function calculateTier(points) {
            if (!loyaltyRules) return 'bronze';
            
            const tiers = loyaltyRules.tiers;
            for (let i = tiers.length - 1; i >= 0; i--) {
                if (points >= tiers[i].pointsRequired) {
                    return tiers[i].id;
                }
            }
            return 'bronze';
        }

        // Load users
        window.loadUsers = async function() {
            console.log('üîÑ Loading users...');
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-12 text-center text-gray-400"><div class="animate-spin w-8 h-8 border-4 border-[#00ff88] border-t-transparent rounded-full mx-auto mb-4"></div>Loading...</td></tr>';

            try {
                await loadLoyaltyRules();

                // Get all orders
                const ordersSnapshot = await getDocs(collection(db, 'orders'));
                console.log(`üì¶ Found ${ordersSnapshot.size} orders`);

                const usersMap = new Map();

                // Process orders
                ordersSnapshot.forEach(orderDoc => {
                    const order = orderDoc.data();
                    const userId = order.userId;
                    if (!userId) return;

                    if (!usersMap.has(userId)) {
                        const email = order.shippingAddress?.email || order.email || 'N/A';
                        const firstName = order.shippingAddress?.firstName || '';
                        const lastName = order.shippingAddress?.lastName || '';
                        const fullName = `${firstName} ${lastName}`.trim() || email.split('@')[0];
                        
                        usersMap.set(userId, {
                            id: userId,
                            name: fullName,
                            email: email,
                            points: 0,
                            tier: 'bronze',
                            orders: [],
                            totalSpent: 0
                        });
                    }

                    const user = usersMap.get(userId);
                    user.orders.push(order);
                    user.totalSpent += (order.total || 0);
                });

                // Load points from userPoints collection
                console.log('‚≠ê Loading points...');
                for (const [userId, user] of usersMap.entries()) {
                    try {
                        const pointsDoc = await getDoc(doc(db, 'userPoints', userId));
                        if (pointsDoc.exists()) {
                            const pointsData = pointsDoc.data();
                            user.points = pointsData.totalPoints || 0;
                            user.tier = pointsData.tier || calculateTier(user.points);
                            console.log(`‚úÖ ${user.name}: ${user.points} points`);
                        } else {
                            console.warn(`‚ö†Ô∏è No points for ${user.name}, will calculate`);
                            // Calculate points from orders
                            const calculatedPoints = Math.floor(user.totalSpent * (loyaltyRules?.pointsEarning?.pointsPerDollar || 0.1));
                            user.points = calculatedPoints;
                            user.tier = calculateTier(calculatedPoints);
                        }
                    } catch (err) {
                        console.error(`Error loading points for ${userId}:`, err);
                    }
                }

                allUsers = Array.from(usersMap.values());
                console.log(`‚úÖ Loaded ${allUsers.length} users`);

                displayUsers(allUsers);
                updateStats(allUsers);

            } catch (error) {
                console.error('‚ùå Error loading users:', error);
                tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-12 text-center text-red-400">Error: ${error.message}</td></tr>`;
            }
        };

        function displayUsers(users) {
            const tbody = document.getElementById('users-table-body');
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-12 text-center text-gray-400">No users found</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => `
                <tr class="border-t border-gray-800 hover:bg-gray-800">
                    <td class="px-6 py-4">${user.name}</td>
                    <td class="px-6 py-4 text-gray-400">${user.email}</td>
                    <td class="px-6 py-4 font-bold text-[#00ff88]">${user.points}</td>
                    <td class="px-6 py-4">
                        <span class="px-3 py-1 rounded-full text-xs font-bold ${getTierClass(user.tier)}">
                            ${user.tier.toUpperCase()}
                        </span>
                    </td>
                    <td class="px-6 py-4">${user.orders.length}</td>
                    <td class="px-6 py-4">
                        <button onclick="openAddPointsModal('${user.id}')" 
                                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold">
                            ‚úèÔ∏è Edit
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function getTierClass(tier) {
            const classes = {
                bronze: 'bg-orange-900 text-orange-200',
                silver: 'bg-gray-600 text-white',
                gold: 'bg-yellow-600 text-yellow-100',
                platinum: 'bg-purple-600 text-purple-100'
            };
            return classes[tier] || classes.bronze;
        }

        function updateStats(users) {
            document.getElementById('stat-total-users').textContent = users.length;
            document.getElementById('stat-total-points').textContent = users.reduce((sum, u) => sum + u.points, 0);
            document.getElementById('stat-total-orders').textContent = users.reduce((sum, u) => sum + u.orders.length, 0);
            document.getElementById('stat-avg-points').textContent = users.length > 0 
                ? Math.floor(users.reduce((sum, u) => sum + u.points, 0) / users.length)
                : 0;
        }

        window.filterUsers = function() {
            const search = document.getElementById('search-users').value.toLowerCase();
            const filtered = allUsers.filter(u => 
                u.name.toLowerCase().includes(search) || 
                u.email.toLowerCase().includes(search)
            );
            displayUsers(filtered);
        };

        window.openAddPointsModal = function(userId) {
            selectedUser = allUsers.find(u => u.id === userId);
            if (!selectedUser) return;

            document.getElementById('modal-user-name').value = selectedUser.name;
            document.getElementById('modal-current-points').value = selectedUser.points;
            document.getElementById('modal-points-amount').value = '';
            document.getElementById('modal-reason').value = '';
            document.getElementById('modal-message').innerHTML = '';
            document.getElementById('add-points-modal').classList.remove('hidden');
        };

        window.closeModal = function() {
            document.getElementById('add-points-modal').classList.add('hidden');
        };

        window.submitAddPoints = async function() {
            const amount = parseInt(document.getElementById('modal-points-amount').value);
            const reason = document.getElementById('modal-reason').value;
            const messageDiv = document.getElementById('modal-message');

            if (isNaN(amount) || amount === 0) {
                messageDiv.innerHTML = '<div class="bg-red-900 border border-red-500 text-red-200 px-4 py-3 rounded-lg mb-4">Please enter a valid amount</div>';
                return;
            }

            if (!reason.trim()) {
                messageDiv.innerHTML = '<div class="bg-red-900 border border-red-500 text-red-200 px-4 py-3 rounded-lg mb-4">Please enter a reason</div>';
                return;
            }

            try {
                messageDiv.innerHTML = '<div class="bg-blue-900 border border-blue-500 text-blue-200 px-4 py-3 rounded-lg mb-4">Updating points...</div>';

                const newPoints = selectedUser.points + amount;
                const newTier = calculateTier(newPoints);

                const pointsRef = doc(db, 'userPoints', selectedUser.id);
                const pointsDoc = await getDoc(pointsRef);

                const transaction = {
                    id: `admin_${Date.now()}`,
                    type: amount > 0 ? 'admin_add' : 'admin_deduct',
                    amount: Math.abs(amount),
                    description: reason,
                    timestamp: new Date().toISOString(),
                    balanceBefore: selectedUser.points,
                    balanceAfter: newPoints
                };

                if (pointsDoc.exists()) {
                    const currentData = pointsDoc.data();
                    await updateDoc(pointsRef, {
                        totalPoints: newPoints,
                        tier: newTier,
                        pointsHistory: [...(currentData.pointsHistory || []), transaction],
                        updatedAt: new Date().toISOString()
                    });
                } else {
                    await setDoc(pointsRef, {
                        userId: selectedUser.id,
                        email: selectedUser.email,
                        displayName: selectedUser.name,
                        totalPoints: newPoints,
                        tier: newTier,
                        pointsHistory: [transaction],
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    });
                }

                messageDiv.innerHTML = '<div class="bg-green-900 border border-green-500 text-green-200 px-4 py-3 rounded-lg mb-4">‚úÖ Points updated successfully!</div>';
                
                setTimeout(() => {
                    closeModal();
                    loadUsers();
                }, 1500);

            } catch (error) {
                console.error('Error updating points:', error);
                messageDiv.innerHTML = `<div class="bg-red-900 border border-red-500 text-red-200 px-4 py-3 rounded-lg mb-4">Error: ${error.message}</div>`;
            }
        };

        // Sync all user points from orders
        window.syncAllPoints = async function() {
            if (!confirm('This will recalculate points for all users based on their orders. Continue?')) return;

            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-12 text-center text-blue-400"><div class="animate-spin w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-4"></div>Syncing all points...</td></tr>';

            try {
                await loadLoyaltyRules();
                let synced = 0;

                for (const user of allUsers) {
                    const calculatedPoints = Math.floor(user.totalSpent * (loyaltyRules?.pointsEarning?.pointsPerDollar || 0.1));
                    const tier = calculateTier(calculatedPoints);

                    const pointsRef = doc(db, 'userPoints', user.id);
                    await setDoc(pointsRef, {
                        userId: user.id,
                        email: user.email,
                        displayName: user.name,
                        totalPoints: calculatedPoints,
                        tier: tier,
                        pointsHistory: [{
                            id: `sync_${Date.now()}`,
                            type: 'admin_add',
                            amount: calculatedPoints,
                            description: 'Points synced from orders',
                            timestamp: new Date().toISOString(),
                            balanceBefore: 0,
                            balanceAfter: calculatedPoints
                        }],
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString(),
                        orderCount: user.orders.length,
                        totalSpent: user.totalSpent
                    }, { merge: true });

                    synced++;
                    console.log(`‚úÖ Synced ${user.name}: ${calculatedPoints} points`);
                }

                alert(`‚úÖ Successfully synced ${synced} users!`);
                loadUsers();

            } catch (error) {
                console.error('Error syncing points:', error);
                alert(`‚ùå Error: ${error.message}`);
                loadUsers();
            }
        };

        // Tab switching
        window.switchTab = function(tab) {
            // Update tab buttons
            document.querySelectorAll('[id^="tab-"]').forEach(btn => {
                btn.classList.remove('tab-active', 'bg-[#00ff88]', 'text-black');
                btn.classList.add('bg-gray-800', 'hover:bg-gray-700', 'text-white');
            });
            document.getElementById(`tab-${tab}`).classList.add('tab-active', 'bg-[#00ff88]', 'text-black');
            document.getElementById(`tab-${tab}`).classList.remove('bg-gray-800', 'hover:bg-gray-700', 'text-white');

            // Update content
            document.querySelectorAll('[id^="content-"]').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(`content-${tab}`).classList.remove('hidden');

            // Load data if needed
            if (tab === 'users' && allUsers.length === 0) {
                loadUsers();
            }
        };

        // Initialize
        console.log('üöÄ Loyalty Admin initialized');
    </script>
</body>
</html>
