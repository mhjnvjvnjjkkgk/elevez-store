<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopify Product Import - Elevez Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header h1 {
            font-size: 28px;
            background: linear-gradient(135deg, #00ff88, #00cc6a);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #00ff88, #00cc6a);
            color: #000;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .status-bar {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .status-message {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
        }

        .status-icon {
            font-size: 24px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            margin-top: 15px;
            overflow: hidden;
            display: none;
        }

        .progress-bar.active {
            display: block;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff88, #00cc6a);
            border-radius: 4px;
            transition: width 0.3s;
            width: 0%;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .product-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
        }

        .product-card:hover {
            transform: translateY(-5px);
            border-color: #00ff88;
            box-shadow: 0 20px 40px rgba(0, 255, 136, 0.15);
        }

        .product-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: #1a1a1a;
        }

        .product-info {
            padding: 16px;
        }

        .product-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #fff;
        }

        .product-price {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .current-price {
            font-size: 18px;
            font-weight: 700;
            color: #00ff88;
        }

        .original-price {
            font-size: 14px;
            color: #ff4444;
            text-decoration: line-through;
        }

        .product-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }

        .tag {
            background: rgba(0, 255, 136, 0.15);
            color: #00ff88;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 500;
        }

        .size-tag {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .color-tag {
            background: rgba(136, 136, 255, 0.15);
            color: #8888ff;
        }

        .product-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .product-actions .btn {
            flex: 1;
            padding: 8px 12px;
            font-size: 12px;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #00ff88;
        }

        .stat-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 4px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: rgba(255, 255, 255, 0.5);
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: #00ff88;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #1a1a2e;
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 6px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #00ff88;
        }

        .back-btn {
            color: rgba(255, 255, 255, 0.6);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            transition: color 0.3s;
        }

        .back-btn:hover {
            color: #00ff88;
        }
    </style>
</head>

<body>
    <div class="container">
        <a href="index.html" class="back-btn">‚Üê Back to Admin Panel</a>

        <div class="header">
            <h1>üõí Shopify Product Import</h1>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-secondary" onclick="clearLocalProducts()">Clear Local Products</button>
                <button class="btn btn-primary" id="importBtn" onclick="importFromShopify()">
                    <span>üì•</span> Import from Shopify
                </button>
                <button class="btn btn-primary" id="syncBtn" onclick="syncToWebsite()"
                    style="background: linear-gradient(135deg, #9945FF, #14F195);">
                    <span>üöÄ</span> Sync to Website (Permanent)
                </button>
            </div>
        </div>

        <div class="status-bar" id="statusBar">
            <div class="status-message">
                <span class="status-icon" id="statusIcon">‚ÑπÔ∏è</span>
                <span id="statusText">Click "Import from Shopify" to fetch products from your store.</span>
            </div>
            <div class="progress-bar" id="progressBar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>

        <div class="stats-row" id="statsRow" style="display: none;">
            <div class="stat-card">
                <div class="stat-value" id="totalProducts">0</div>
                <div class="stat-label">Total Products</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalVariants">0</div>
                <div class="stat-label">Total Variants</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalCollections">0</div>
                <div class="stat-label">Collections</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="inStockCount">0</div>
                <div class="stat-label">In Stock</div>
            </div>
        </div>

        <div class="products-grid" id="productsGrid">
            <div class="empty-state">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1"
                        d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                </svg>
                <h3>No Products Imported</h3>
                <p>Click the import button to fetch products from your Shopify store</p>
            </div>
        </div>
    </div>

    <!-- Edit Product Modal -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Product (Local Only)</h3>
                <button class="btn btn-secondary" onclick="closeEditModal()" style="padding: 8px 12px;">‚úï</button>
            </div>
            <div class="modal-body" id="editModalBody">
                <!-- Form content injected dynamically -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveProductEdit()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyA-EPPt6384wdlz7wjDofpBkSaT3APqUxs",
            authDomain: "elevez-trial.firebaseapp.com",
            projectId: "elevez-trial",
            storageBucket: "elevez-trial.appspot.com",
            messagingSenderId: "397135095498",
            appId: "1:397135095498:web:d7cfc4b4b7b8db2e8c67ac"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Shopify config
        const SHOPIFY_DOMAIN = '5m5zyn-kb.myshopify.com';
        const STOREFRONT_TOKEN = '46f2270efd1603329aa7d2593eac38a9';
        const API_VERSION = '2024-01';
        const STOREFRONT_URL = `https://${SHOPIFY_DOMAIN}/api/${API_VERSION}/graphql.json`;

        let importedProducts = [];
        let editingProduct = null;

        // GraphQL query for products
        const PRODUCTS_QUERY = `
            query GetAllProducts($first: Int!) {
                products(first: $first) {
                    edges {
                        node {
                            id
                            handle
                            title
                            description
                            descriptionHtml
                            productType
                            vendor
                            tags
                            priceRange {
                                minVariantPrice { amount currencyCode }
                            }
                            compareAtPriceRange {
                                minVariantPrice { amount currencyCode }
                            }
                            images(first: 10) {
                                edges {
                                    node { id url altText width height }
                                }
                            }
                            variants(first: 50) {
                                edges {
                                    node {
                                        id title sku
                                        price { amount currencyCode }
                                        compareAtPrice { amount currencyCode }
                                        availableForSale
                                        selectedOptions { name value }
                                    }
                                }
                            }
                            options { id name values }
                            collections(first: 5) {
                                edges { node { id handle title } }
                            }
                        }
                    }
                }
            }
        `;

        // GraphQL query for collections
        const COLLECTIONS_QUERY = `
            query GetAllCollections($first: Int!) {
                collections(first: $first) {
                    edges {
                        node {
                            id
                            handle
                            title
                            description
                            image { url altText }
                            products(first: 100) {
                                edges {
                                    node {
                                        id
                                        handle
                                    }
                                }
                            }
                        }
                    }
                }
            }
        `;

        // Global variables for collections
        let importedCollections = [];
        window.importedCollections = [];

        // Fetch collections from Shopify
        async function fetchShopifyCollections() {
            const response = await fetch(STOREFRONT_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Shopify-Storefront-Access-Token': STOREFRONT_TOKEN,
                },
                body: JSON.stringify({
                    query: COLLECTIONS_QUERY,
                    variables: { first: 50 }
                }),
            });

            if (!response.ok) {
                throw new Error(`Shopify API error: ${response.status}`);
            }

            const json = await response.json();
            if (json.errors) {
                throw new Error(json.errors[0]?.message || 'GraphQL error');
            }

            return json.data.collections.edges.map(edge => edge.node);
        }

        // Parse collection to local format
        function parseCollection(node, index) {
            const productHandles = node.products.edges.map(e => e.node.handle);

            // Detect if this is a special collection for section mapping
            const handleLower = node.handle.toLowerCase();
            const titleLower = node.title.toLowerCase();

            let sectionMapping = null;
            if (handleLower.includes('best-seller') || titleLower.includes('best seller')) {
                sectionMapping = 'bestSellers';
            } else if (handleLower.includes('new') || titleLower.includes('new arrival')) {
                sectionMapping = 'newArrivals';
            } else if (handleLower.includes('featured')) {
                sectionMapping = 'featured';
            }

            return {
                id: `shopify-${node.handle}`,
                shopifyId: node.id,
                handle: node.handle,
                name: node.title,
                description: node.description || '',
                image: node.image?.url || '',
                productHandles: productHandles,
                productCount: productHandles.length,
                sectionMapping: sectionMapping,
                order: index,
                isSystem: false,
                source: 'shopify',
                importedAt: new Date().toISOString()
            };
        }

        // Fetch from Shopify
        async function fetchShopifyProducts() {
            const response = await fetch(STOREFRONT_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Shopify-Storefront-Access-Token': STOREFRONT_TOKEN,
                },
                body: JSON.stringify({
                    query: PRODUCTS_QUERY,
                    variables: { first: 100 }
                }),
            });

            if (!response.ok) {
                throw new Error(`Shopify API error: ${response.status}`);
            }

            const json = await response.json();
            if (json.errors) {
                throw new Error(json.errors[0]?.message || 'GraphQL error');
            }

            return json.data.products.edges.map(edge => edge.node);
        }

        // Parse Shopify product to local format
        function parseProduct(node, index) {
            const images = node.images.edges.map(e => e.node);
            const variants = node.variants.edges.map(e => e.node);

            const sizeOption = node.options.find(o =>
                o.name.toLowerCase().includes('size')
            );
            const colorOption = node.options.find(o =>
                o.name.toLowerCase().includes('color') || o.name.toLowerCase().includes('colour')
            );

            const price = parseFloat(node.priceRange.minVariantPrice.amount);
            const compareAt = node.compareAtPriceRange?.minVariantPrice?.amount;
            const originalPrice = compareAt ? parseFloat(compareAt) : price * 2;

            return {
                id: index + 1,
                shopifyId: node.id,
                handle: node.handle,
                name: node.title,
                description: node.description || '',
                descriptionHtml: node.descriptionHtml || '',
                price: price,
                originalPrice: originalPrice,
                image: images[0]?.url || '',
                images: images.map(i => i.url),
                type: node.productType || 'tee',
                tags: node.tags || [],
                sizes: sizeOption?.values || ['S', 'M', 'L', 'XL'],
                colors: colorOption?.values || [],
                collections: node.collections?.edges?.map(e => e.node.title) || [],
                variants: variants.map(v => ({
                    id: v.id,
                    title: v.title,
                    sku: v.sku || '',
                    price: parseFloat(v.price.amount),
                    compareAtPrice: v.compareAtPrice ? parseFloat(v.compareAtPrice.amount) : null,
                    availableForSale: v.availableForSale,
                    options: v.selectedOptions
                })),
                inStock: variants.some(v => v.availableForSale),
                rating: (4 + Math.random()).toFixed(1),
                reviews: Math.floor(Math.random() * 200) + 20,
                source: 'shopify',
                importedAt: new Date().toISOString()
            };
        }

        // Update UI status
        function updateStatus(icon, text, showProgress = false, progress = 0) {
            document.getElementById('statusIcon').textContent = icon;
            document.getElementById('statusText').textContent = text;

            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');

            if (showProgress) {
                progressBar.classList.add('active');
                progressFill.style.width = `${progress}%`;
            } else {
                progressBar.classList.remove('active');
            }
        }

        // Import from Shopify
        async function importFromShopify() {
            const btn = document.getElementById('importBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div> Importing...';

            try {
                updateStatus('üîÑ', 'Connecting to Shopify...', true, 10);
                console.log('üîÑ Starting Shopify import...');

                // Fetch products
                const shopifyProducts = await fetchShopifyProducts();
                console.log('‚úÖ Fetched products:', shopifyProducts.length);
                console.log('üì¶ Product titles:', shopifyProducts.map(p => p.title));

                updateStatus('üì¶', `Found ${shopifyProducts.length} products, fetching collections...`, true, 30);

                // Fetch collections
                let shopifyCollections = [];
                try {
                    shopifyCollections = await fetchShopifyCollections();
                    console.log('‚úÖ Fetched collections:', shopifyCollections.length);
                    console.log('üìÇ Collection titles:', shopifyCollections.map(c => c.title));
                } catch (collectionError) {
                    console.warn('‚ö†Ô∏è Could not fetch collections:', collectionError.message);
                }

                updateStatus('‚öôÔ∏è', `Processing ${shopifyProducts.length} products and ${shopifyCollections.length} collections...`, true, 50);

                // Parse products
                importedProducts = shopifyProducts.map((p, i) => parseProduct(p, i));
                console.log('‚úÖ Parsed products:', importedProducts.length);

                // Parse collections and map to products
                importedCollections = shopifyCollections.map((c, i) => parseCollection(c, i));
                window.importedCollections = importedCollections;
                console.log('‚úÖ Parsed collections:', importedCollections.length);

                // Map collection section flags to products
                importedCollections.forEach(collection => {
                    if (collection.sectionMapping) {
                        collection.productHandles.forEach(handle => {
                            const product = importedProducts.find(p => p.handle === handle);
                            if (product) {
                                if (collection.sectionMapping === 'bestSellers') {
                                    product.isBestSeller = true;
                                } else if (collection.sectionMapping === 'newArrivals') {
                                    product.isNew = true;
                                } else if (collection.sectionMapping === 'featured') {
                                    product.isFeatured = true;
                                }
                            }
                        });
                    }
                });

                updateStatus('üíæ', 'Saving to Firebase...', true, 70);

                // SHOW PRODUCTS FIRST (before Firebase save)
                renderProducts();
                updateStats();
                console.log('üéâ Products rendered!');
                updateStatus('‚úÖ', `Successfully imported ${importedProducts.length} products and ${importedCollections.length} collections!`, true, 100);

                // Try to save to Firebase in background (optional)
                try {
                    // Clear existing shopify products first
                    const existing = await db.collection('shopifyProducts').get();
                    console.log('üóëÔ∏è Clearing', existing.size, 'existing products');

                    const deletePromises = existing.docs.map(doc => doc.ref.delete());
                    await Promise.all(deletePromises);

                    // Add new products one by one
                    console.log('üíæ Saving', importedProducts.length, 'products...');
                    for (const product of importedProducts) {
                        await db.collection('shopifyProducts').doc(product.handle).set(product);
                    }

                    console.log('‚úÖ All products saved to Firebase');
                } catch (firebaseError) {
                    console.warn('‚ö†Ô∏è Firebase save skipped (permission issue):', firebaseError.message);
                    // Products are already displayed, so no error shown to user
                }

            } catch (error) {
                console.error('Import error:', error);
                updateStatus('‚ùå', `Error: ${error.message}`, false);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span>üì•</span> Import from Shopify';

                setTimeout(() => {
                    document.getElementById('progressBar').classList.remove('active');
                }, 2000);
            }
        }

        // Render products grid
        function renderProducts() {
            const grid = document.getElementById('productsGrid');

            if (importedProducts.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                        </svg>
                        <h3>No Products Imported</h3>
                        <p>Click the import button to fetch products from your Shopify store</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = importedProducts.map(product => `
                <div class="product-card">
                    <img src="${product.image || 'https://via.placeholder.com/300x200?text=No+Image'}" 
                         alt="${product.name}" 
                         class="product-image"
                         onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'">
                    <div class="product-info">
                        <div class="product-title">${product.name}</div>
                        <div class="product-price">
                            <span class="current-price">‚Çπ${product.price.toFixed(2)}</span>
                            ${product.originalPrice > product.price ?
                    `<span class="original-price">‚Çπ${product.originalPrice.toFixed(2)}</span>` : ''}
                        </div>
                        <div class="product-meta">
                            ${product.sizes.slice(0, 4).map(s => `<span class="tag size-tag">${s}</span>`).join('')}
                            ${product.colors.slice(0, 2).map(c => `<span class="tag color-tag">${c}</span>`).join('')}
                        </div>
                        <div class="product-meta">
                            ${product.collections.slice(0, 2).map(c => `<span class="tag">${c}</span>`).join('')}
                            ${product.inStock ? '<span class="tag">In Stock</span>' : '<span class="tag" style="background:rgba(255,68,68,0.15);color:#ff4444;">Out of Stock</span>'}
                        </div>
                        <div class="product-actions">
                            <button class="btn btn-secondary" onclick="editProduct('${product.handle}')">‚úèÔ∏è Edit</button>
                            <button class="btn btn-primary" onclick="viewProduct('${product.handle}')">üëÅÔ∏è View</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Update stats
        function updateStats() {
            document.getElementById('statsRow').style.display = 'grid';
            document.getElementById('totalProducts').textContent = importedProducts.length;
            document.getElementById('totalVariants').textContent =
                importedProducts.reduce((sum, p) => sum + (p.variants?.length || 0), 0);

            const collections = new Set();
            importedProducts.forEach(p => p.collections?.forEach(c => collections.add(c)));
            document.getElementById('totalCollections').textContent = collections.size;

            document.getElementById('inStockCount').textContent =
                importedProducts.filter(p => p.inStock).length;
        }

        // Edit product (local only)
        function editProduct(handle) {
            editingProduct = importedProducts.find(p => p.handle === handle);
            if (!editingProduct) return;

            document.getElementById('editModalBody').innerHTML = `
                <div class="form-group">
                    <label>Product Name</label>
                    <input type="text" id="editName" value="${editingProduct.name}">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="editDescription" rows="3">${editingProduct.description}</textarea>
                </div>
                <div class="form-group">
                    <label>Price (‚Çπ)</label>
                    <input type="number" id="editPrice" value="${editingProduct.price}" step="0.01">
                </div>
                <div class="form-group">
                    <label>Original Price (‚Çπ)</label>
                    <input type="number" id="editOriginalPrice" value="${editingProduct.originalPrice}" step="0.01">
                </div>
                <div class="form-group">
                    <label>Sizes (comma separated)</label>
                    <input type="text" id="editSizes" value="${editingProduct.sizes.join(', ')}">
                </div>
                <div class="form-group">
                    <label>Colors (comma separated)</label>
                    <input type="text" id="editColors" value="${editingProduct.colors.join(', ')}">
                </div>
                <div class="form-group">
                    <label>Tags (comma separated)</label>
                    <input type="text" id="editTags" value="${editingProduct.tags.join(', ')}">
                </div>
                <p style="font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 10px;">
                    ‚ö†Ô∏è Changes are saved locally only and won't affect your Shopify store.
                </p>
            `;

            document.getElementById('editModal').classList.add('active');
        }

        // Save product edit
        async function saveProductEdit() {
            if (!editingProduct) return;

            const updates = {
                name: document.getElementById('editName').value,
                description: document.getElementById('editDescription').value,
                price: parseFloat(document.getElementById('editPrice').value),
                originalPrice: parseFloat(document.getElementById('editOriginalPrice').value),
                sizes: document.getElementById('editSizes').value.split(',').map(s => s.trim()).filter(Boolean),
                colors: document.getElementById('editColors').value.split(',').map(c => c.trim()).filter(Boolean),
                tags: document.getElementById('editTags').value.split(',').map(t => t.trim()).filter(Boolean),
                updatedAt: new Date().toISOString()
            };

            try {
                await db.collection('shopifyProducts').doc(editingProduct.handle).update(updates);

                // Update local array
                Object.assign(editingProduct, updates);
                renderProducts();
                closeEditModal();

                updateStatus('‚úÖ', `Product "${updates.name}" updated successfully (local only)`, false);
            } catch (error) {
                console.error('Save error:', error);
                updateStatus('‚ùå', `Error saving: ${error.message}`, false);
            }
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            editingProduct = null;
        }

        // View product details
        function viewProduct(handle) {
            const product = importedProducts.find(p => p.handle === handle);
            if (!product) return;

            alert(`Product: ${product.name}\n\nPrice: ‚Çπ${product.price}\nOriginal: ‚Çπ${product.originalPrice}\nSizes: ${product.sizes.join(', ')}\nColors: ${product.colors.join(', ')}\nCollections: ${product.collections.join(', ')}\nVariants: ${product.variants?.length || 0}\nIn Stock: ${product.inStock ? 'Yes' : 'No'}`);
        }

        // Clear local products
        async function clearLocalProducts() {
            if (!confirm('Are you sure you want to clear all imported products?')) return;

            try {
                const snapshot = await db.collection('shopifyProducts').get();
                const batch = db.batch();
                snapshot.forEach(doc => batch.delete(doc.ref));
                await batch.commit();

                importedProducts = [];
                renderProducts();
                document.getElementById('statsRow').style.display = 'none';
                updateStatus('üóëÔ∏è', 'All imported products cleared.', false);
            } catch (error) {
                console.error('Clear error:', error);
                updateStatus('‚ùå', `Error: ${error.message}`, false);
            }
        }

        // =========================================
        // SYNC TO WEBSITE - PERMANENT OFFLINE COPY
        // =========================================
        window.syncToWebsite = async function () {
            console.log('üöÄ syncToWebsite called! importedProducts:', importedProducts.length);
            console.log('üìÇ syncToWebsite importedCollections:', importedCollections?.length || 0, importedCollections);

            if (importedProducts.length === 0) {
                alert('‚ùå No products to sync! Import from Shopify first.\n\nClick "Import from Shopify" button first, wait for products to load, then click "Sync to Website".');
                return;
            }

            updateStatus('üîÑ', 'Converting products to website format...', true, 10);

            try {
                // Get existing products from localStorage
                const existingProducts = JSON.parse(localStorage.getItem('elevez_products') || '[]');
                const existingIds = new Set(existingProducts.map(p => p.shopifyHandle || p.handle));

                // Convert Shopify products to local format
                const newProducts = importedProducts.map((product, index) => {
                    // Generate unique ID
                    const baseId = existingProducts.length + index + 1;
                    const qid = `SHOP-${product.handle.toUpperCase().replace(/-/g, '').substring(0, 8)}`;

                    // Extract SKU from variants if available
                    const sku = product.variants?.[0]?.sku || `SKU-${Date.now()}-${index}`;

                    // Determine category and type from Shopify data
                    let category = 'Topwear';
                    let type = 'Tee';

                    const nameLower = product.name.toLowerCase();
                    if (nameLower.includes('hoodie') || nameLower.includes('sweatshirt')) {
                        type = 'Hoodie';
                    } else if (nameLower.includes('jacket')) {
                        type = 'Jacket';
                    } else if (nameLower.includes('pants') || nameLower.includes('jogger') || nameLower.includes('cargo')) {
                        category = 'Bottomwear';
                        type = 'Pants';
                    } else if (nameLower.includes('shorts')) {
                        category = 'Bottomwear';
                        type = 'Shorts';
                    } else if (nameLower.includes('cap') || nameLower.includes('hat')) {
                        category = 'Accessories';
                        type = 'Cap';
                    }

                    // Override with Shopify product type if available
                    if (product.type) {
                        type = product.type;
                    }

                    return {
                        id: baseId,
                        qid: qid,
                        sku: sku,
                        shopifyHandle: product.handle,
                        shopifyId: product.shopifyId,
                        name: product.name,
                        price: product.price,
                        originalPrice: product.originalPrice,
                        cost: Math.round(product.price * 0.4), // Estimate cost as 40% of price
                        category: category,
                        type: type,
                        rating: parseFloat(product.rating) || 4.5,
                        reviews: product.reviews || Math.floor(Math.random() * 100) + 10,
                        description: product.description || '',
                        descriptionHtml: product.descriptionHtml || '',
                        image: product.image || '',
                        images: product.images || [product.image].filter(Boolean),
                        sizes: product.sizes || ['S', 'M', 'L', 'XL'],
                        colors: product.colors || [],
                        tags: product.tags || [],
                        collections: product.collections || [],
                        variants: product.variants || [],
                        inStock: product.inStock !== false,
                        stock: 100, // Default stock
                        // Preserve section mapping flags from import
                        isBestSeller: product.isBestSeller || false,
                        isNew: product.isNew || true,
                        isFeatured: product.isFeatured || false,
                        source: 'shopify',
                        importedAt: new Date().toISOString(),
                        lastSyncedAt: new Date().toISOString()
                    };
                });

                updateStatus('üíæ', 'Saving to local database...', true, 50);

                // Filter out duplicates (products already synced)
                const productsToAdd = newProducts.filter(p => !existingIds.has(p.shopifyHandle));

                // Get all products (existing + new)
                const allProducts = productsToAdd.length > 0
                    ? [...existingProducts, ...productsToAdd]
                    : existingProducts;

                // Always save products (even if no new ones, to update existing data)
                if (productsToAdd.length > 0) {
                    localStorage.setItem('elevez_products', JSON.stringify(allProducts));
                    localStorage.setItem('elevez_last_save', new Date().toISOString());
                    console.log('‚úÖ Saved', productsToAdd.length, 'new products');
                }

                // ALWAYS save collections (even if no new products)
                // Use window.importedCollections which is set during import
                const collectionsToSave = window.importedCollections || importedCollections || [];
                console.log('üìÇ Collections to save:', collectionsToSave.length);

                if (collectionsToSave && collectionsToSave.length > 0) {
                    const existingCollections = JSON.parse(localStorage.getItem('elevez_collections') || '[]');
                    const existingCollectionIds = new Set(existingCollections.map(c => c.handle));

                    // Filter new collections and merge
                    const newCollections = collectionsToSave.filter(c => !existingCollectionIds.has(c.handle));
                    const allCollections = [...existingCollections, ...newCollections];

                    // Add "All Products" collection if not exists
                    if (!allCollections.find(c => c.handle === 'all')) {
                        allCollections.unshift({
                            id: 'all',
                            handle: 'all',
                            name: 'All Products',
                            description: 'Browse all products',
                            image: '',
                            productHandles: allProducts.map(p => p.shopifyHandle || p.handle),
                            productCount: allProducts.length,
                            sectionMapping: null,
                            order: -1,
                            isSystem: true,
                            source: 'local',
                            importedAt: new Date().toISOString()
                        });
                    } else {
                        // Update the All Products collection with new product handles
                        const allColl = allCollections.find(c => c.handle === 'all');
                        if (allColl) {
                            allColl.productHandles = allProducts.map(p => p.shopifyHandle || p.handle);
                            allColl.productCount = allProducts.length;
                        }
                    }

                    localStorage.setItem('elevez_collections', JSON.stringify(allCollections));
                    console.log('‚úÖ Saved', allCollections.length, 'collections to localStorage');
                }

                // Also save to server for cross-origin access (different ports have separate localStorage)
                try {
                    const collectionsToSaveToServer = collectionsToSave || [];
                    const response = await fetch('/api/save-shopify-data', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            products: allProducts,
                            collections: collectionsToSaveToServer
                        })
                    });
                    const result = await response.json();
                    if (result.success) {
                        console.log('‚úÖ Saved to server:', result.productsSaved, 'products,', result.collectionsSaved, 'collections');
                    }
                } catch (serverError) {
                    console.warn('‚ö†Ô∏è Could not save to server (will work via localStorage):', serverError.message);
                }

                // Report results
                if (productsToAdd.length === 0 && (!collectionsToSave || collectionsToSave.length === 0)) {
                    updateStatus('‚ö†Ô∏è', 'All products already synced! No new data to add.', false);
                    return;
                }

                updateStatus('‚úÖ', `Synced ${productsToAdd.length} products and ${collectionsToSave?.length || 0} collections!`, true, 100);
                console.log('‚úÖ Products saved to localStorage:', productsToAdd.length);
                console.log('üì¶ Total products in database:', allProducts.length);

                // Auto-redirect to Product Manager after 2 seconds
                setTimeout(() => {
                    alert(`‚úÖ Shopify Sync Complete!\n\nüì¶ ${productsToAdd.length} new products synced\nüìÇ ${collectionsToSave?.length || 0} collections imported\n\nTotal: ${allProducts.length} products\n\nRedirecting to Product Manager...`);
                    window.location.href = 'index.html?refresh=' + Date.now();
                }, 1500);

            } catch (error) {
                console.error('Sync error:', error);
                updateStatus('‚ùå', `Error syncing: ${error.message}`, false);
            }
        }

        // Load existing products on page load
        async function loadExistingProducts() {
            try {
                // First try to load from memory (already imported)
                if (importedProducts.length > 0) {
                    renderProducts();
                    updateStats();
                    return;
                }

                // Show count of already synced products
                const existingProducts = JSON.parse(localStorage.getItem('elevez_products') || '[]');
                const shopifyProducts = existingProducts.filter(p => p.source === 'shopify');
                if (shopifyProducts.length > 0) {
                    updateStatus('‚ÑπÔ∏è', `${shopifyProducts.length} Shopify products already synced to website. Click Import to refresh from Shopify.`, false);
                }
            } catch (error) {
                console.error('Load error:', error);
            }
        }

        // Initialize
        loadExistingProducts();
    </script>
</body>

</html>